var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(r){var v=0;return function(){return v<r.length?{done:!1,value:r[v++]}:{done:!0}}};$jscomp.arrayIterator=function(r){return{next:$jscomp.arrayIteratorImpl(r)}};$jscomp.makeIterator=function(r){var v="undefined"!=typeof Symbol&&Symbol.iterator&&r[Symbol.iterator];return v?v.call(r):$jscomp.arrayIterator(r)};
$jscomp.getGlobal=function(r){return"undefined"!=typeof window&&window===r?r:"undefined"!=typeof global&&null!=global?global:r};$jscomp.global=$jscomp.getGlobal(this);$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(r,v,a){r!=Array.prototype&&r!=Object.prototype&&(r[v]=a.value)};
$jscomp.polyfill=function(r,v,a,n){if(v){a=$jscomp.global;r=r.split(".");for(n=0;n<r.length-1;n++){var e=r[n];e in a||(a[e]={});a=a[e]}r=r[r.length-1];n=a[r];v=v(n);v!=n&&null!=v&&$jscomp.defineProperty(a,r,{configurable:!0,writable:!0,value:v})}};$jscomp.FORCE_POLYFILL_PROMISE=!1;
$jscomp.polyfill("Promise",function(r){function v(){this.batch_=null}function a(a){return a instanceof e?a:new e(function(h,e){h(a)})}if(r&&!$jscomp.FORCE_POLYFILL_PROMISE)return r;v.prototype.asyncExecute=function(a){if(null==this.batch_){this.batch_=[];var h=this;this.asyncExecuteFunction(function(){h.executeBatch_()})}this.batch_.push(a)};var n=$jscomp.global.setTimeout;v.prototype.asyncExecuteFunction=function(a){n(a,0)};v.prototype.executeBatch_=function(){for(;this.batch_&&this.batch_.length;){var a=
this.batch_;this.batch_=[];for(var t=0;t<a.length;++t){var e=a[t];a[t]=null;try{e()}catch(m){this.asyncThrow_(m)}}}this.batch_=null};v.prototype.asyncThrow_=function(a){this.asyncExecuteFunction(function(){throw a;})};var e=function(a){this.state_=0;this.result_=void 0;this.onSettledCallbacks_=[];var h=this.createResolveAndReject_();try{a(h.resolve,h.reject)}catch(w){h.reject(w)}};e.prototype.createResolveAndReject_=function(){function a(a){return function(b){w||(w=!0,a.call(e,b))}}var e=this,w=!1;
return{resolve:a(this.resolveTo_),reject:a(this.reject_)}};e.prototype.resolveTo_=function(a){if(a===this)this.reject_(new TypeError("A Promise cannot resolve to itself"));else if(a instanceof e)this.settleSameAsPromise_(a);else{a:switch(typeof a){case "object":var h=null!=a;break a;case "function":h=!0;break a;default:h=!1}h?this.resolveToNonPromiseObj_(a):this.fulfill_(a)}};e.prototype.resolveToNonPromiseObj_=function(a){var h=void 0;try{h=a.then}catch(w){this.reject_(w);return}"function"==typeof h?
this.settleSameAsThenable_(h,a):this.fulfill_(a)};e.prototype.reject_=function(a){this.settle_(2,a)};e.prototype.fulfill_=function(a){this.settle_(1,a)};e.prototype.settle_=function(a,e){if(0!=this.state_)throw Error("Cannot settle("+a+", "+e+"): Promise already settled in state"+this.state_);this.state_=a;this.result_=e;this.executeOnSettledCallbacks_()};e.prototype.executeOnSettledCallbacks_=function(){if(null!=this.onSettledCallbacks_){for(var a=0;a<this.onSettledCallbacks_.length;++a)q.asyncExecute(this.onSettledCallbacks_[a]);
this.onSettledCallbacks_=null}};var q=new v;e.prototype.settleSameAsPromise_=function(a){var h=this.createResolveAndReject_();a.callWhenSettled_(h.resolve,h.reject)};e.prototype.settleSameAsThenable_=function(a,e){var h=this.createResolveAndReject_();try{a.call(e,h.resolve,h.reject)}catch(m){h.reject(m)}};e.prototype.then=function(a,t){function h(a,g){return"function"==typeof a?function(g){try{m(a(g))}catch(x){b(x)}}:g}var m,b,k=new e(function(a,g){m=a;b=g});this.callWhenSettled_(h(a,m),h(t,b));return k};
e.prototype.catch=function(a){return this.then(void 0,a)};e.prototype.callWhenSettled_=function(a,e){function h(){switch(m.state_){case 1:a(m.result_);break;case 2:e(m.result_);break;default:throw Error("Unexpected state: "+m.state_);}}var m=this;null==this.onSettledCallbacks_?q.asyncExecute(h):this.onSettledCallbacks_.push(h)};e.resolve=a;e.reject=function(a){return new e(function(h,e){e(a)})};e.race=function(h){return new e(function(e,w){for(var m=$jscomp.makeIterator(h),b=m.next();!b.done;b=m.next())a(b.value).callWhenSettled_(e,
w)})};e.all=function(h){var t=$jscomp.makeIterator(h),w=t.next();return w.done?a([]):new e(function(h,b){function k(a){return function(b){u[a]=b;g--;0==g&&h(u)}}var u=[],g=0;do u.push(void 0),g++,a(w.value).callWhenSettled_(k(u.length-1),b),w=t.next();while(!w.done)})};return e},"es6","es3");
(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{"3jZv":function(r,v,a){a.d(v,"a",function(){return n.a});a.d(v,"b",function(){return e.a});var n=a("llUH");a("fqU1");var e=a("itUE"),q=a("oYeq"),h=a("/SR9"),t=a("srWW");a("IS0N");a("QcF5");a("8uwT");var w=a("n5HA"),m=a("T5H4"),b=a("qAwy"),k=a("uyO6"),u=a("e2Mr"),g=h.e.Up(),y=h.e.Zero(),x=new h.e,B=new h.e,C=new h.a,A=new h.a,l=function(c){function d(z,D,f){if(d.IsSupported)return z=c.call(this,z,D,f)||this,z.usePercentageCloserFiltering=!0,
z;k.a.Error("CascadedShadowMap needs WebGL 2 support.")}Object(q.d)(d,c);d.prototype._validateFilter=function(c){if(c===e.a.FILTER_NONE||c===e.a.FILTER_PCF||c===e.a.FILTER_PCSS)return c;console.error('Unsupported filter "'+c+'"!');return e.a.FILTER_NONE};Object.defineProperty(d.prototype,"numCascades",{get:function(){return this._numCascades},set:function(c){c=Math.min(Math.max(c,d.MIN_CASCADES_COUNT),d.MAX_CASCADES_COUNT);c!==this._numCascades&&(this._numCascades=c,this.recreateShadowMap())},enumerable:!1,
configurable:!0});Object.defineProperty(d.prototype,"freezeShadowCastersBoundingInfo",{get:function(){return this._freezeShadowCastersBoundingInfo},set:function(c){this._freezeShadowCastersBoundingInfoObservable&&c&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null);this._freezeShadowCastersBoundingInfoObservable||c||(this._freezeShadowCastersBoundingInfoObservable=this._scene.onBeforeRenderObservable.add(this._computeShadowCastersBoundingInfo.bind(this)));
(this._freezeShadowCastersBoundingInfo=c)&&this._computeShadowCastersBoundingInfo()},enumerable:!1,configurable:!0});d.prototype._computeShadowCastersBoundingInfo=function(){this._scbiMin.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);this._scbiMax.copyFromFloats(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE);if(this._shadowMap&&this._shadowMap.renderList){for(var c=this._shadowMap.renderList,d=0;d<c.length;d++){var f=c[d];f&&(f=f.getBoundingInfo(),f=f.boundingBox,this._scbiMin.minimizeInPlace(f.minimumWorld),
this._scbiMax.maximizeInPlace(f.maximumWorld))}c=this._scene.meshes;for(d=0;d<c.length;d++)(f=c[d])&&f.isVisible&&f.isEnabled&&f.receiveShadows&&(f=f.getBoundingInfo(),f=f.boundingBox,this._scbiMin.minimizeInPlace(f.minimumWorld),this._scbiMax.maximizeInPlace(f.maximumWorld))}this._shadowCastersBoundingInfo.reConstruct(this._scbiMin,this._scbiMax)};Object.defineProperty(d.prototype,"shadowCastersBoundingInfo",{get:function(){return this._shadowCastersBoundingInfo},set:function(c){this._shadowCastersBoundingInfo=
c},enumerable:!1,configurable:!0});d.prototype.setMinMaxDistance=function(c,d){if(this._minDistance!==c||this._maxDistance!==d)c>d&&(c=0,d=1),0>c&&(c=0),1<d&&(d=1),this._minDistance=c,this._maxDistance=d,this._breaksAreDirty=!0};Object.defineProperty(d.prototype,"minDistance",{get:function(){return this._minDistance},enumerable:!1,configurable:!0});Object.defineProperty(d.prototype,"maxDistance",{get:function(){return this._maxDistance},enumerable:!1,configurable:!0});d.prototype.getClassName=function(){return d.CLASSNAME};
d.prototype.getCascadeMinExtents=function(c){return 0<=c&&c<this._numCascades?this._cascadeMinExtents[c]:null};d.prototype.getCascadeMaxExtents=function(c){return 0<=c&&c<this._numCascades?this._cascadeMaxExtents[c]:null};Object.defineProperty(d.prototype,"shadowMaxZ",{get:function(){return this._scene&&this._scene.activeCamera?this._shadowMaxZ:0},set:function(c){this._scene&&this._scene.activeCamera?this._shadowMaxZ===c||c<this._scene.activeCamera.minZ||c>this._scene.activeCamera.maxZ||(this._shadowMaxZ=
c,this._light._markMeshesAsLightDirty(),this._breaksAreDirty=!0):this._shadowMaxZ=c},enumerable:!1,configurable:!0});Object.defineProperty(d.prototype,"debug",{get:function(){return this._debug},set:function(c){this._debug=c;this._light._markMeshesAsLightDirty()},enumerable:!1,configurable:!0});Object.defineProperty(d.prototype,"depthClamp",{get:function(){return this._depthClamp},set:function(c){this._depthClamp=c},enumerable:!1,configurable:!0});Object.defineProperty(d.prototype,"cascadeBlendPercentage",
{get:function(){return this._cascadeBlendPercentage},set:function(c){this._cascadeBlendPercentage=c;this._light._markMeshesAsLightDirty()},enumerable:!1,configurable:!0});Object.defineProperty(d.prototype,"lambda",{get:function(){return this._lambda},set:function(c){c=Math.min(Math.max(c,0),1);this._lambda!=c&&(this._lambda=c,this._breaksAreDirty=!0)},enumerable:!1,configurable:!0});d.prototype.getCascadeViewMatrix=function(c){return 0<=c&&c<this._numCascades?this._viewMatrices[c]:null};d.prototype.getCascadeProjectionMatrix=
function(c){return 0<=c&&c<this._numCascades?this._projectionMatrices[c]:null};d.prototype.getCascadeTransformMatrix=function(c){return 0<=c&&c<this._numCascades?this._transformMatrices[c]:null};d.prototype.setDepthRenderer=function(c){this._depthRenderer=c;this._depthReducer&&this._depthReducer.setDepthRenderer(this._depthRenderer)};Object.defineProperty(d.prototype,"autoCalcDepthBounds",{get:function(){return this._autoCalcDepthBounds},set:function(c){var d=this,z=this._scene.activeCamera;z&&((this._autoCalcDepthBounds=
c)?(this._depthReducer||(this._depthReducer=new b.a(z),this._depthReducer.onAfterReductionPerformed.add(function(c){var z=c.min;c=c.max;z>=c&&(z=0,c=1);z==d._minDistance&&c==d._maxDistance||d.setMinMaxDistance(z,c)}),this._depthReducer.setDepthRenderer(this._depthRenderer)),this._depthReducer.activate()):(this._depthReducer&&this._depthReducer.deactivate(),this.setMinMaxDistance(0,1)))},enumerable:!1,configurable:!0});Object.defineProperty(d.prototype,"autoCalcDepthBoundsRefreshRate",{get:function(){var c,
d,f;return null!==(f=null===(d=null===(c=this._depthReducer)||void 0===c?void 0:c.depthRenderer)||void 0===d?void 0:d.getDepthMap().refreshRate)&&void 0!==f?f:-1},set:function(c){var d;if(null===(d=this._depthReducer)||void 0===d?0:d.depthRenderer)this._depthReducer.depthRenderer.getDepthMap().refreshRate=c},enumerable:!1,configurable:!0});d.prototype.splitFrustum=function(){this._breaksAreDirty=!0};d.prototype._splitFrustum=function(){var c=this._scene.activeCamera;if(c){var d=c.minZ,f=c.maxZ;c=
f-d;var a=this._minDistance,l=d+a*c,p=d+(this._shadowMaxZ<f&&this._shadowMaxZ>=d?Math.min((this._shadowMaxZ-d)/(f-d),this._maxDistance):this._maxDistance)*c;f=p-l;p/=l;for(var b=0;b<this._cascades.length;++b){var g=(b+1)/this._numCascades,A=l+f*g;g=this._lambda*(l*Math.pow(p,g)-A)+A;this._cascades[b].prevBreakDistance=0===b?a:this._cascades[b-1].breakDistance;this._cascades[b].breakDistance=(g-d)/c;this._viewSpaceFrustumsZ[b]=d+this._cascades[b].breakDistance*c;this._frustumLengths[b]=(this._cascades[b].breakDistance-
this._cascades[b].prevBreakDistance)*c}this._breaksAreDirty=!1}};d.prototype._computeMatrices=function(){if(this._scene.activeCamera){h.e.NormalizeToRef(this._light.getShadowDirection(0),this._lightDirection);1===Math.abs(h.e.Dot(this._lightDirection,h.e.Up()))&&(this._lightDirection.z=1E-13);this._cachedDirection.copyFrom(this._lightDirection);for(var c=0;c<this._numCascades;++c){this._computeFrustumInWorldSpace(c);this._computeCascadeFrustum(c);this._cascadeMaxExtents[c].subtractToRef(this._cascadeMinExtents[c],
x);this._frustumCenter[c].addToRef(this._lightDirection.scale(this._cascadeMinExtents[c].z),this._shadowCameraPos[c]);h.a.LookAtLHToRef(this._shadowCameraPos[c],this._frustumCenter[c],g,this._viewMatrices[c]);var d=0,f=x.z,a=this._shadowCastersBoundingInfo;a.update(this._viewMatrices[c]);f=Math.min(f,a.boundingBox.maximumWorld.z);d=this._depthClamp&&this.filter!==e.a.FILTER_PCSS?Math.max(d,a.boundingBox.minimumWorld.z):Math.min(d,a.boundingBox.minimumWorld.z);h.a.OrthoOffCenterLHToRef(this._cascadeMinExtents[c].x,
this._cascadeMaxExtents[c].x,this._cascadeMinExtents[c].y,this._cascadeMaxExtents[c].y,d,f,this._projectionMatrices[c]);this._cascadeMinExtents[c].z=d;this._cascadeMaxExtents[c].z=f;this._viewMatrices[c].multiplyToRef(this._projectionMatrices[c],this._transformMatrices[c]);h.e.TransformCoordinatesToRef(y,this._transformMatrices[c],x);x.scaleInPlace(this._mapSize/2);B.copyFromFloats(Math.round(x.x),Math.round(x.y),Math.round(x.z));B.subtractInPlace(x).scaleInPlace(2/this._mapSize);h.a.TranslationToRef(B.x,
B.y,0,C);this._projectionMatrices[c].multiplyToRef(C,this._projectionMatrices[c]);this._viewMatrices[c].multiplyToRef(this._projectionMatrices[c],this._transformMatrices[c]);this._transformMatrices[c].copyToArray(this._transformMatricesAsArray,16*c)}}};d.prototype._computeFrustumInWorldSpace=function(c){if(this._scene.activeCamera){var f=this._cascades[c].prevBreakDistance,a=this._cascades[c].breakDistance;this._scene.activeCamera.getViewMatrix();for(var l=h.a.Invert(this._scene.activeCamera.getTransformationMatrix()),
z=0;z<d.frustumCornersNDCSpace.length;++z)h.e.TransformCoordinatesToRef(d.frustumCornersNDCSpace[z],l,this._frustumCornersWorldSpace[c][z]);for(z=0;z<d.frustumCornersNDCSpace.length/2;++z)x.copyFrom(this._frustumCornersWorldSpace[c][z+4]).subtractInPlace(this._frustumCornersWorldSpace[c][z]),B.copyFrom(x).scaleInPlace(f),x.scaleInPlace(a),x.addInPlace(this._frustumCornersWorldSpace[c][z]),this._frustumCornersWorldSpace[c][z+4].copyFrom(x),this._frustumCornersWorldSpace[c][z].addInPlace(B)}};d.prototype._computeCascadeFrustum=
function(c){this._cascadeMinExtents[c].copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);this._cascadeMaxExtents[c].copyFromFloats(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE);this._frustumCenter[c].copyFromFloats(0,0,0);if(this._scene.activeCamera){for(var d=0;d<this._frustumCornersWorldSpace[c].length;++d)this._frustumCenter[c].addInPlace(this._frustumCornersWorldSpace[c][d]);this._frustumCenter[c].scaleInPlace(1/this._frustumCornersWorldSpace[c].length);if(this.stabilizeCascades){var f=
0;for(d=0;d<this._frustumCornersWorldSpace[c].length;++d){var a=this._frustumCornersWorldSpace[c][d].subtractToRef(this._frustumCenter[c],x).length();f=Math.max(f,a)}f=Math.ceil(16*f)/16;this._cascadeMaxExtents[c].copyFromFloats(f,f,f);this._cascadeMinExtents[c].copyFromFloats(-f,-f,-f)}else for(d=this._frustumCenter[c],this._frustumCenter[c].addToRef(this._lightDirection,x),h.a.LookAtLHToRef(d,x,g,C),d=0;d<this._frustumCornersWorldSpace[c].length;++d)h.e.TransformCoordinatesToRef(this._frustumCornersWorldSpace[c][d],
C,x),this._cascadeMinExtents[c].minimizeInPlace(x),this._cascadeMaxExtents[c].maximizeInPlace(x)}};Object.defineProperty(d,"IsSupported",{get:function(){var c=u.a.LastCreatedEngine;return c?1!=c.webGLVersion:!1},enumerable:!1,configurable:!0});d.prototype._initializeGenerator=function(){var f,a,l,b,p,g,A,C,k,u,e,y,t,x,w,n,q,B,r,v;this.penumbraDarkness=null!==(f=this.penumbraDarkness)&&void 0!==f?f:1;this._numCascades=null!==(a=this._numCascades)&&void 0!==a?a:d.DEFAULT_CASCADES_COUNT;this.stabilizeCascades=
null!==(l=this.stabilizeCascades)&&void 0!==l?l:!1;this._freezeShadowCastersBoundingInfoObservable=null!==(b=this._freezeShadowCastersBoundingInfoObservable)&&void 0!==b?b:null;this.freezeShadowCastersBoundingInfo=null!==(p=this.freezeShadowCastersBoundingInfo)&&void 0!==p?p:!1;this._scbiMin=null!==(g=this._scbiMin)&&void 0!==g?g:new h.e(0,0,0);this._scbiMax=null!==(A=this._scbiMax)&&void 0!==A?A:new h.e(0,0,0);this._shadowCastersBoundingInfo=null!==(C=this._shadowCastersBoundingInfo)&&void 0!==C?
C:new m.a(new h.e(0,0,0),new h.e(0,0,0));this._breaksAreDirty=null!==(k=this._breaksAreDirty)&&void 0!==k?k:!0;this._minDistance=null!==(u=this._minDistance)&&void 0!==u?u:0;this._maxDistance=null!==(e=this._maxDistance)&&void 0!==e?e:1;this._currentLayer=null!==(y=this._currentLayer)&&void 0!==y?y:0;this._shadowMaxZ=null!==(w=null!==(t=this._shadowMaxZ)&&void 0!==t?t:null===(x=this._scene.activeCamera)||void 0===x?void 0:x.maxZ)&&void 0!==w?w:1E4;this._debug=null!==(n=this._debug)&&void 0!==n?n:
!1;this._depthClamp=null!==(q=this._depthClamp)&&void 0!==q?q:!0;this._cascadeBlendPercentage=null!==(B=this._cascadeBlendPercentage)&&void 0!==B?B:.1;this._lambda=null!==(r=this._lambda)&&void 0!==r?r:.5;this._autoCalcDepthBounds=null!==(v=this._autoCalcDepthBounds)&&void 0!==v?v:!1;c.prototype._initializeGenerator.call(this)};d.prototype._createTargetRenderTexture=function(){this._shadowMap=new t.a(this._light.name+"_shadowMap",{width:this._mapSize,height:this._mapSize,layers:this.numCascades},
this._scene,!1,!0,this._textureType,!1,void 0,!1,!1,void 0);this._shadowMap.createDepthStencilTexture(513,!0)};d.prototype._initializeShadowMap=function(){var f=this;c.prototype._initializeShadowMap.call(this);if(null!==this._shadowMap){this._transformMatricesAsArray=new Float32Array(16*this._numCascades);this._viewSpaceFrustumsZ=Array(this._numCascades);this._frustumLengths=Array(this._numCascades);this._lightSizeUVCorrection=Array(2*this._numCascades);this._depthCorrection=Array(this._numCascades);
this._cascades=[];this._viewMatrices=[];this._projectionMatrices=[];this._transformMatrices=[];this._cascadeMinExtents=[];this._cascadeMaxExtents=[];this._frustumCenter=[];this._shadowCameraPos=[];this._frustumCornersWorldSpace=[];for(var a=0;a<this._numCascades;++a){this._cascades[a]={prevBreakDistance:0,breakDistance:0};this._viewMatrices[a]=h.a.Zero();this._projectionMatrices[a]=h.a.Zero();this._transformMatrices[a]=h.a.Zero();this._cascadeMinExtents[a]=new h.e;this._cascadeMaxExtents[a]=new h.e;
this._frustumCenter[a]=new h.e;this._shadowCameraPos[a]=new h.e;this._frustumCornersWorldSpace[a]=Array(d.frustumCornersNDCSpace.length);for(var l=0;l<d.frustumCornersNDCSpace.length;++l)this._frustumCornersWorldSpace[a][l]=new h.e}this._shadowMap.onBeforeRenderObservable.add(function(c){f._currentLayer=c;if(f._scene.getSceneUniformBuffer().useUbo){var d=f._scene.getSceneUniformBuffer();d.updateMatrix("viewProjection",f.getCascadeTransformMatrix(c));d.updateMatrix("view",f.getCascadeViewMatrix(c));
d.update()}});this._shadowMap.onBeforeBindObservable.add(function(){f._breaksAreDirty&&f._splitFrustum();f._computeMatrices()});this._splitFrustum()}};d.prototype._bindCustomEffectForRenderSubMeshForShadowMap=function(c,d,f,a){var l,b,p,g,z,D;d.setMatrix(null!==(l=null===f||void 0===f?void 0:f.viewProjection)&&void 0!==l?l:"viewProjection",this.getCascadeTransformMatrix(this._currentLayer));d.setMatrix(null!==(b=null===f||void 0===f?void 0:f.view)&&void 0!==b?b:"view",this.getCascadeViewMatrix(this._currentLayer));
d.setMatrix(null!==(p=null===f||void 0===f?void 0:f.projection)&&void 0!==p?p:"projection",this.getCascadeProjectionMatrix(this._currentLayer));c=a.getWorldMatrix();d.setMatrix(null!==(g=null===f||void 0===f?void 0:f.world)&&void 0!==g?g:"world",c);c.multiplyToRef(this.getCascadeTransformMatrix(this._currentLayer),C);d.setMatrix(null!==(z=null===f||void 0===f?void 0:f.worldViewProjection)&&void 0!==z?z:"worldViewProjection",C);c.multiplyToRef(this.getCascadeViewMatrix(this._currentLayer),A);d.setMatrix(null!==
(D=null===f||void 0===f?void 0:f.worldView)&&void 0!==D?D:"worldView",A)};d.prototype._isReadyCustomDefines=function(c,d,f){c.push("#define SM_DEPTHCLAMP "+(this._depthClamp&&this._filter!==e.a.FILTER_PCSS?"1":"0"))};d.prototype.prepareDefines=function(d,f){c.prototype.prepareDefines.call(this,d,f);var a=this._scene,l=this._light;a.shadowsEnabled&&l.shadowEnabled&&(d["SHADOWCSM"+f]=!0,d["SHADOWCSMDEBUG"+f]=this.debug,d["SHADOWCSMNUM_CASCADES"+f]=this.numCascades,d["SHADOWCSM_RIGHTHANDED"+f]=a.useRightHandedSystem,
(a=a.activeCamera)&&this._shadowMaxZ<a.maxZ&&(d["SHADOWCSMUSESHADOWMAXZ"+f]=!0),0===this.cascadeBlendPercentage&&(d["SHADOWCSMNOBLEND"+f]=!0))};d.prototype.bindShadowLight=function(c,d){var f=this._light,a=this._scene;if(a.shadowsEnabled&&f.shadowEnabled&&(a=a.activeCamera)){var l=this.getShadowMap();if(l){var b=l.getSize().width;d.setMatrices("lightMatrix"+c,this._transformMatricesAsArray);d.setArray("viewFrustumZ"+c,this._viewSpaceFrustumsZ);d.setFloat("cascadeBlendFactor"+c,0===this.cascadeBlendPercentage?
1E4:1/this.cascadeBlendPercentage);d.setArray("frustumLengths"+c,this._frustumLengths);if(this._filter===e.a.FILTER_PCF)d.setDepthStencilTexture("shadowSampler"+c,l),f._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),b,1/b,this.frustumEdgeFalloff,c);else if(this._filter===e.a.FILTER_PCSS){for(var p=0;p<this._numCascades;++p)this._lightSizeUVCorrection[2*p]=0===p?1:(this._cascadeMaxExtents[0].x-this._cascadeMinExtents[0].x)/(this._cascadeMaxExtents[p].x-this._cascadeMinExtents[p].x),this._lightSizeUVCorrection[2*
p+1]=0===p?1:(this._cascadeMaxExtents[0].y-this._cascadeMinExtents[0].y)/(this._cascadeMaxExtents[p].y-this._cascadeMinExtents[p].y),this._depthCorrection[p]=0===p?1:(this._cascadeMaxExtents[p].z-this._cascadeMinExtents[p].z)/(this._cascadeMaxExtents[0].z-this._cascadeMinExtents[0].z);d.setDepthStencilTexture("shadowSampler"+c,l);d.setTexture("depthSampler"+c,l);d.setArray2("lightSizeUVCorrection"+c,this._lightSizeUVCorrection);d.setArray("depthCorrection"+c,this._depthCorrection);d.setFloat("penumbraDarkness"+
c,this.penumbraDarkness);f._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/b,this._contactHardeningLightSizeUVRatio*b,this.frustumEdgeFalloff,c)}else d.setTexture("shadowSampler"+c,l),f._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),b,1/b,this.frustumEdgeFalloff,c);f._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(a),this.getLight().getDepthMinZ(a)+this.getLight().getDepthMaxZ(a),c)}}};d.prototype.getTransformMatrix=function(){return this.getCascadeTransformMatrix(0)};
d.prototype.dispose=function(){c.prototype.dispose.call(this);this._freezeShadowCastersBoundingInfoObservable&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null);this._depthReducer&&(this._depthReducer.dispose(),this._depthReducer=null)};d.prototype.serialize=function(){var d=c.prototype.serialize.call(this),f=this.getShadowMap();if(!f)return d;d.numCascades=this._numCascades;d.debug=this._debug;d.stabilizeCascades=
this.stabilizeCascades;d.lambda=this._lambda;d.cascadeBlendPercentage=this.cascadeBlendPercentage;d.depthClamp=this._depthClamp;d.autoCalcDepthBounds=this.autoCalcDepthBounds;d.shadowMaxZ=this._shadowMaxZ;d.penumbraDarkness=this.penumbraDarkness;d.freezeShadowCastersBoundingInfo=this._freezeShadowCastersBoundingInfo;d.minDistance=this.minDistance;d.maxDistance=this.maxDistance;d.renderList=[];if(f.renderList)for(var a=0;a<f.renderList.length;a++)d.renderList.push(f.renderList[a].id);return d};d.Parse=
function(c,f){f=e.a.Parse(c,f,function(c,f){return new d(c,f)});void 0!==c.numCascades&&(f.numCascades=c.numCascades);void 0!==c.debug&&(f.debug=c.debug);void 0!==c.stabilizeCascades&&(f.stabilizeCascades=c.stabilizeCascades);void 0!==c.lambda&&(f.lambda=c.lambda);void 0!==c.cascadeBlendPercentage&&(f.cascadeBlendPercentage=c.cascadeBlendPercentage);void 0!==c.depthClamp&&(f.depthClamp=c.depthClamp);void 0!==c.autoCalcDepthBounds&&(f.autoCalcDepthBounds=c.autoCalcDepthBounds);void 0!==c.shadowMaxZ&&
(f.shadowMaxZ=c.shadowMaxZ);void 0!==c.penumbraDarkness&&(f.penumbraDarkness=c.penumbraDarkness);void 0!==c.freezeShadowCastersBoundingInfo&&(f.freezeShadowCastersBoundingInfo=c.freezeShadowCastersBoundingInfo);void 0!==c.minDistance&&void 0!==c.maxDistance&&f.setMinMaxDistance(c.minDistance,c.maxDistance);return f};d.frustumCornersNDCSpace=[new h.e(-1,1,-1),new h.e(1,1,-1),new h.e(1,-1,-1),new h.e(-1,-1,-1),new h.e(-1,1,1),new h.e(1,1,1),new h.e(1,-1,1),new h.e(-1,-1,1)];d.CLASSNAME="CascadedShadowGenerator";
d.DEFAULT_CASCADES_COUNT=4;d.MIN_CASCADES_COUNT=2;d.MAX_CASCADES_COUNT=4;d._SceneComponentInitialization=function(c){throw w.a.WarnImport("ShadowGeneratorSceneComponent");};return d}(e.a),p=a("Yap0");a("KbzI").a.AddParser(p.a.NAME_SHADOWGENERATOR,function(c,d){if(void 0!==c.shadowGenerators&&null!==c.shadowGenerators)for(var f=0,a=c.shadowGenerators.length;f<a;f++){var p=c.shadowGenerators[f];p.className===l.CLASSNAME?l.Parse(p,d):e.a.Parse(p,d)}});var c=function(){function c(c){this.name=p.a.NAME_SHADOWGENERATOR;
this.scene=c}c.prototype.register=function(){this.scene._gatherRenderTargetsStage.registerStep(p.a.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR,this,this._gatherRenderTargets)};c.prototype.rebuild=function(){};c.prototype.serialize=function(c){c.shadowGenerators=[];for(var d=0,f=this.scene.lights;d<f.length;d++){var a=f[d].getShadowGenerator();a&&c.shadowGenerators.push(a.serialize())}};c.prototype.addFromContainer=function(c){};c.prototype.removeFromContainer=function(c,f){};c.prototype.dispose=function(){};
c.prototype._gatherRenderTargets=function(c){var d=this.scene;if(this.scene.shadowsEnabled)for(var f=0;f<d.lights.length;f++){var a=d.lights[f],l=a.getShadowGenerator();a.isEnabled()&&a.shadowEnabled&&l&&(a=l.getShadowMap(),-1!==d.textures.indexOf(a)&&c.push(a))}};return c}();e.a._SceneComponentInitialization=function(f){var d=f._getComponent(p.a.NAME_SHADOWGENERATOR);d||(d=new c(f),f._addComponent(d))};a("lFBE");a("SqLj");a("zZL8");a("pVyc")},"8XHp":function(r,v,a){var n=a("CAkI"),e=a("Yap0"),q=
a("tgKJ");r=a("KbzI");r.a.AddParser(e.a.NAME_EFFECTLAYER,function(a,h,e,b){if(a.effectLayers){e.effectLayers||(e.effectLayers=[]);for(var k=0;k<a.effectLayers.length;k++){var u=q.a.Parse(a.effectLayers[k],h,b);e.effectLayers.push(u)}}});r.a.prototype.removeEffectLayer=function(a){a=this.effectLayers.indexOf(a);-1!==a&&this.effectLayers.splice(a,1);return a};r.a.prototype.addEffectLayer=function(a){this.effectLayers.push(a)};var h=function(){function a(a){this.name=e.a.NAME_EFFECTLAYER;this._previousStencilState=
this._needStencil=this._renderEffects=!1;this.scene=a;this._engine=a.getEngine();a.effectLayers=[]}a.prototype.register=function(){this.scene._isReadyForMeshStage.registerStep(e.a.STEP_ISREADYFORMESH_EFFECTLAYER,this,this._isReadyForMesh);this.scene._cameraDrawRenderTargetStage.registerStep(e.a.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER,this,this._renderMainTexture);this.scene._beforeCameraDrawStage.registerStep(e.a.STEP_BEFORECAMERADRAW_EFFECTLAYER,this,this._setStencil);this.scene._afterRenderingGroupDrawStage.registerStep(e.a.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW,
this,this._drawRenderingGroup);this.scene._afterCameraDrawStage.registerStep(e.a.STEP_AFTERCAMERADRAW_EFFECTLAYER,this,this._setStencilBack);this.scene._afterCameraDrawStage.registerStep(e.a.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW,this,this._drawCamera)};a.prototype.rebuild=function(){for(var a=0,h=this.scene.effectLayers;a<h.length;a++)h[a]._rebuild()};a.prototype.serialize=function(a){a.effectLayers=[];for(var h=0,b=this.scene.effectLayers;h<b.length;h++){var k=b[h];k.serialize&&a.effectLayers.push(k.serialize())}};
a.prototype.addFromContainer=function(a){var h=this;a.effectLayers&&a.effectLayers.forEach(function(a){h.scene.addEffectLayer(a)})};a.prototype.removeFromContainer=function(a,h){var b=this;a.effectLayers&&a.effectLayers.forEach(function(a){b.scene.removeEffectLayer(a);h&&a.dispose()})};a.prototype.dispose=function(){for(var a=this.scene.effectLayers;a.length;)a[0].dispose()};a.prototype._isReadyForMesh=function(a,h){for(var b=0,k=this.scene.effectLayers;b<k.length;b++){var u=k[b];if(u.hasMesh(a))for(var g=
0,e=a.subMeshes;g<e.length;g++)if(!u.isReady(e[g],h))return!1}return!0};a.prototype._renderMainTexture=function(a){var h=this._needStencil=this._renderEffects=!1,b=this.scene.effectLayers;if(b&&0<b.length){this._previousStencilState=this._engine.getStencilBuffer();for(var k=0;k<b.length;k++){var u=b[k];u.shouldRender()&&(!u.camera||u.camera.cameraRigMode===n.a.RIG_MODE_NONE&&a===u.camera||u.camera.cameraRigMode!==n.a.RIG_MODE_NONE&&-1<u.camera._rigCameras.indexOf(a))&&(this._renderEffects=!0,this._needStencil=
this._needStencil||u.needStencil(),u=u._mainTexture,u._shouldRender()&&(this.scene.incrementRenderId(),u.render(!1,!1),h=!0))}this.scene.incrementRenderId()}return h};a.prototype._setStencil=function(){this._needStencil&&this._engine.setStencilBuffer(!0)};a.prototype._setStencilBack=function(){this._needStencil&&this._engine.setStencilBuffer(this._previousStencilState)};a.prototype._draw=function(a){if(this._renderEffects){this._engine.setDepthBuffer(!1);for(var h=this.scene.effectLayers,b=0;b<h.length;b++){var k=
h[b];k.renderingGroupId===a&&k.shouldRender()&&k.render()}this._engine.setDepthBuffer(!0)}};a.prototype._drawCamera=function(){this._renderEffects&&this._draw(-1)};a.prototype._drawRenderingGroup=function(a){!this.scene._isInIntermediateRendering()&&this._renderEffects&&this._draw(a)};return a}();q.a._SceneComponentInitialization=function(a){var n=a._getComponent(e.a.NAME_EFFECTLAYER);n||(n=new h(a),a._addComponent(n))}},K32H:function(r,v,a){a.d(v,"a",function(){return e});var n=a("Yap0"),e=function(){function a(a){this.name=
n.a.NAME_LAYER;this.scene=a;this._engine=a.getEngine();a.layers=[]}a.prototype.register=function(){this.scene._beforeCameraDrawStage.registerStep(n.a.STEP_BEFORECAMERADRAW_LAYER,this,this._drawCameraBackground);this.scene._afterCameraDrawStage.registerStep(n.a.STEP_AFTERCAMERADRAW_LAYER,this,this._drawCameraForeground);this.scene._beforeRenderTargetDrawStage.registerStep(n.a.STEP_BEFORERENDERTARGETDRAW_LAYER,this,this._drawRenderTargetBackground);this.scene._afterRenderTargetDrawStage.registerStep(n.a.STEP_AFTERRENDERTARGETDRAW_LAYER,
this,this._drawRenderTargetForeground)};a.prototype.rebuild=function(){for(var a=0,e=this.scene.layers;a<e.length;a++)e[a]._rebuild()};a.prototype.dispose=function(){for(var a=this.scene.layers;a.length;)a[0].dispose()};a.prototype._draw=function(a){var h=this.scene.layers;if(h.length){this._engine.setDepthBuffer(!1);for(var e=0;e<h.length;e++){var m=h[e];a(m)&&m.render()}this._engine.setDepthBuffer(!0)}};a.prototype._drawCameraPredicate=function(a,e,n){return!a.renderOnlyInRenderTargetTextures&&
a.isBackground===e&&0!==(a.layerMask&n)};a.prototype._drawCameraBackground=function(a){var e=this;this._draw(function(h){return e._drawCameraPredicate(h,!0,a.layerMask)})};a.prototype._drawCameraForeground=function(a){var e=this;this._draw(function(h){return e._drawCameraPredicate(h,!1,a.layerMask)})};a.prototype._drawRenderTargetPredicate=function(a,e,n,m){return 0<a.renderTargetTextures.length&&a.isBackground===e&&-1<a.renderTargetTextures.indexOf(m)&&0!==(a.layerMask&n)};a.prototype._drawRenderTargetBackground=
function(a){var e=this;this._draw(function(h){return e._drawRenderTargetPredicate(h,!0,e.scene.activeCamera.layerMask,a)})};a.prototype._drawRenderTargetForeground=function(a){var e=this;this._draw(function(h){return e._drawRenderTargetPredicate(h,!1,e.scene.activeCamera.layerMask,a)})};a.prototype.addFromContainer=function(a){var e=this;a.layers&&a.layers.forEach(function(a){e.scene.layers.push(a)})};a.prototype.removeFromContainer=function(a,e){var h=this;void 0===e&&(e=!1);a.layers&&a.layers.forEach(function(a){var b=
h.scene.layers.indexOf(a);-1!==b&&h.scene.layers.splice(b,1);e&&a.dispose()})};return a}()},M8EM:function(r,v,a){a.d(v,"a",function(){return y});var n=a("oYeq"),e=a("ADVu"),q=a("/SR9"),h=a("y4Ty"),t=a("aCSs"),w=a("srWW"),m=a("cdI9"),b=a("AGTA");r=a("tgKJ");v=a("KbzI");var k=a("WHS4"),u=a("qUIE"),g=a("Xeau");a("YzlU");a("ibn2");a("8XHp");v.a.prototype.getGlowLayerByName=function(a){for(var b=0;b<this.effectLayers.length;b++)if(this.effectLayers[b].name===a&&this.effectLayers[b].getEffectName()===y.EffectName)return this.effectLayers[b];
return null};var y=function(a){function k(b,A,l){b=a.call(this,b,A)||this;b._intensity=1;b._includedOnlyMeshes=[];b._excludedMeshes=[];b._meshesUsingTheirOwnMaterials=[];b.neutralColor=new g.b(0,0,0,1);b._options=Object(n.a)({mainTextureRatio:k.DefaultTextureRatio,blurKernelSize:32,mainTextureFixedSize:void 0,camera:null,mainTextureSamples:1,renderingGroupId:-1},l);b._init({alphaBlendingMode:1,camera:b._options.camera,mainTextureFixedSize:b._options.mainTextureFixedSize,mainTextureRatio:b._options.mainTextureRatio,
renderingGroupId:b._options.renderingGroupId});return b}Object(n.d)(k,a);Object.defineProperty(k.prototype,"blurKernelSize",{get:function(){return this._horizontalBlurPostprocess1.kernel},set:function(a){this._horizontalBlurPostprocess1.kernel=a;this._verticalBlurPostprocess1.kernel=a;this._horizontalBlurPostprocess2.kernel=a;this._verticalBlurPostprocess2.kernel=a},enumerable:!1,configurable:!0});Object.defineProperty(k.prototype,"intensity",{get:function(){return this._intensity},set:function(a){this._intensity=
a},enumerable:!1,configurable:!0});k.prototype.getEffectName=function(){return k.EffectName};k.prototype._createMergeEffect=function(){return this._engine.createEffect("glowMapMerge",[h.b.PositionKind],["offset"],["textureSampler","textureSampler2"],"#define EMISSIVE \n")};k.prototype._createTextureAndPostProcesses=function(){var a=this,g=this._mainTextureDesiredSize.width,l=this._mainTextureDesiredSize.height;g=this._engine.needPOTTextures?u.a.GetExponentOfTwo(g,this._maxSize):g;l=this._engine.needPOTTextures?
u.a.GetExponentOfTwo(l,this._maxSize):l;var p=0;p=this._engine.getCaps().textureHalfFloatRender?2:0;this._blurTexture1=new w.a("GlowLayerBlurRTT",{width:g,height:l},this._scene,!1,!0,p);this._blurTexture1.wrapU=t.a.CLAMP_ADDRESSMODE;this._blurTexture1.wrapV=t.a.CLAMP_ADDRESSMODE;this._blurTexture1.updateSamplingMode(t.a.BILINEAR_SAMPLINGMODE);this._blurTexture1.renderParticles=!1;this._blurTexture1.ignoreCameraViewport=!0;var c=Math.floor(g/2),f=Math.floor(l/2);this._blurTexture2=new w.a("GlowLayerBlurRTT2",
{width:c,height:f},this._scene,!1,!0,p);this._blurTexture2.wrapU=t.a.CLAMP_ADDRESSMODE;this._blurTexture2.wrapV=t.a.CLAMP_ADDRESSMODE;this._blurTexture2.updateSamplingMode(t.a.BILINEAR_SAMPLINGMODE);this._blurTexture2.renderParticles=!1;this._blurTexture2.ignoreCameraViewport=!0;this._textures=[this._blurTexture1,this._blurTexture2];this._horizontalBlurPostprocess1=new b.a("GlowLayerHBP1",new q.d(1,0),this._options.blurKernelSize/2,{width:g,height:l},null,t.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),
!1,p);this._horizontalBlurPostprocess1.width=g;this._horizontalBlurPostprocess1.height=l;this._horizontalBlurPostprocess1.onApplyObservable.add(function(c){c.setTexture("textureSampler",a._mainTexture)});this._verticalBlurPostprocess1=new b.a("GlowLayerVBP1",new q.d(0,1),this._options.blurKernelSize/2,{width:g,height:l},null,t.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,p);this._horizontalBlurPostprocess2=new b.a("GlowLayerHBP2",new q.d(1,0),this._options.blurKernelSize/2,{width:c,height:f},
null,t.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,p);this._horizontalBlurPostprocess2.width=c;this._horizontalBlurPostprocess2.height=f;this._horizontalBlurPostprocess2.onApplyObservable.add(function(c){c.setTexture("textureSampler",a._blurTexture1)});this._verticalBlurPostprocess2=new b.a("GlowLayerVBP2",new q.d(0,1),this._options.blurKernelSize/2,{width:c,height:f},null,t.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,p);this._postProcesses=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1,
this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2];this._postProcesses1=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1];this._postProcesses2=[this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2];this._mainTexture.samples=this._options.mainTextureSamples;this._mainTexture.onAfterUnbindObservable.add(function(){var c=a._blurTexture1.getInternalTexture();if(c){a._scene.postProcessManager.directRender(a._postProcesses1,c,!0);var f=a._blurTexture2.getInternalTexture();
f&&a._scene.postProcessManager.directRender(a._postProcesses2,f,!0);a._engine.unBindFramebuffer(null!==f&&void 0!==f?f:c,!0)}});this._postProcesses.map(function(c){c.autoClear=!1})};k.prototype.isReady=function(b,g){var l=b.getMaterial(),p=b.getRenderingMesh();return l&&p?a.prototype._isReady.call(this,b,g,l.emissiveTexture):!1};k.prototype.needStencil=function(){return!1};k.prototype._canRenderMesh=function(a,b){return!0};k.prototype._internalRender=function(a){a.setTexture("textureSampler",this._blurTexture1);
a.setTexture("textureSampler2",this._blurTexture2);a.setFloat("offset",this._intensity);a=this._engine;var b=a.getStencilBuffer();a.setStencilBuffer(!1);a.drawElementsType(m.a.TriangleFillMode,0,6);a.setStencilBuffer(b)};k.prototype._setEmissiveTextureAndColor=function(a,b,l){var p=1;this.customEmissiveTextureSelector?this._emissiveTextureAndColor.texture=this.customEmissiveTextureSelector(a,b,l):l?(this._emissiveTextureAndColor.texture=l.emissiveTexture,this._emissiveTextureAndColor.texture&&(p=
this._emissiveTextureAndColor.texture.level)):this._emissiveTextureAndColor.texture=null;this.customEmissiveColorSelector?this.customEmissiveColorSelector(a,b,l,this._emissiveTextureAndColor.color):l.emissiveColor?this._emissiveTextureAndColor.color.set(l.emissiveColor.r*p,l.emissiveColor.g*p,l.emissiveColor.b*p,l.alpha):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a)};k.prototype._shouldRenderMesh=function(a){return this.hasMesh(a)};
k.prototype._addCustomEffectDefines=function(a){a.push("#define GLOW")};k.prototype.addExcludedMesh=function(a){-1===this._excludedMeshes.indexOf(a.uniqueId)&&this._excludedMeshes.push(a.uniqueId)};k.prototype.removeExcludedMesh=function(a){a=this._excludedMeshes.indexOf(a.uniqueId);-1!==a&&this._excludedMeshes.splice(a,1)};k.prototype.addIncludedOnlyMesh=function(a){-1===this._includedOnlyMeshes.indexOf(a.uniqueId)&&this._includedOnlyMeshes.push(a.uniqueId)};k.prototype.removeIncludedOnlyMesh=function(a){a=
this._includedOnlyMeshes.indexOf(a.uniqueId);-1!==a&&this._includedOnlyMeshes.splice(a,1)};k.prototype.hasMesh=function(b){return a.prototype.hasMesh.call(this,b)?this._includedOnlyMeshes.length?-1!==this._includedOnlyMeshes.indexOf(b.uniqueId):this._excludedMeshes.length?-1===this._excludedMeshes.indexOf(b.uniqueId):!0:!1};k.prototype._useMeshMaterial=function(a){return 0==this._meshesUsingTheirOwnMaterials.length?!1:-1<this._meshesUsingTheirOwnMaterials.indexOf(a.uniqueId)};k.prototype.referenceMeshToUseItsOwnMaterial=
function(a){this._meshesUsingTheirOwnMaterials.push(a.uniqueId)};k.prototype.unReferenceMeshFromUsingItsOwnMaterial=function(a){for(var b=this._meshesUsingTheirOwnMaterials.indexOf(a.uniqueId);0<=b;)this._meshesUsingTheirOwnMaterials.splice(b,1),b=this._meshesUsingTheirOwnMaterials.indexOf(a.uniqueId)};k.prototype._disposeMesh=function(a){this.removeIncludedOnlyMesh(a);this.removeExcludedMesh(a)};k.prototype.getClassName=function(){return"GlowLayer"};k.prototype.serialize=function(){var a=e.a.Serialize(this);
a.customType="BABYLON.GlowLayer";var b;a.includedMeshes=[];if(this._includedOnlyMeshes.length)for(b=0;b<this._includedOnlyMeshes.length;b++){var l=this._scene.getMeshByUniqueID(this._includedOnlyMeshes[b]);l&&a.includedMeshes.push(l.id)}a.excludedMeshes=[];if(this._excludedMeshes.length)for(b=0;b<this._excludedMeshes.length;b++)(l=this._scene.getMeshByUniqueID(this._excludedMeshes[b]))&&a.excludedMeshes.push(l.id);return a};k.Parse=function(a,b,l){l=e.a.Parse(function(){return new k(a.name,b,a.options)},
a,b,l);var p;for(p=0;p<a.excludedMeshes.length;p++){var c=b.getMeshByID(a.excludedMeshes[p]);c&&l.addExcludedMesh(c)}for(p=0;p<a.includedMeshes.length;p++)(c=b.getMeshByID(a.includedMeshes[p]))&&l.addIncludedOnlyMesh(c);return l};k.EffectName="GlowLayer";k.DefaultBlurKernelSize=32;k.DefaultTextureRatio=.5;Object(n.c)([Object(e.c)()],k.prototype,"blurKernelSize",null);Object(n.c)([Object(e.c)()],k.prototype,"intensity",null);Object(n.c)([Object(e.c)("options")],k.prototype,"_options",void 0);return k}(r.a);
k.a.RegisteredTypes["BABYLON.GlowLayer"]=y},SqLj:function(r,v,a){a.d(v,"a",function(){return w});var n=a("oYeq"),e=a("ADVu"),q=a("/SR9"),h=a("Xeau");r=a("Ufda");var t=a("llUH");r.a.AddNodeConstructor("Light_Type_3",function(a,b){return function(){return new w(a,q.e.Zero(),b)}});var w=function(a){function b(b,e,g){b=a.call(this,b,g)||this;b.groundColor=new h.a(0,0,0);b.direction=e||q.e.Up();return b}Object(n.d)(b,a);b.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",
4);this._uniformBuffer.addUniform("vLightDiffuse",4);this._uniformBuffer.addUniform("vLightSpecular",4);this._uniformBuffer.addUniform("vLightGround",3);this._uniformBuffer.addUniform("shadowsInfo",3);this._uniformBuffer.addUniform("depthValues",2);this._uniformBuffer.create()};b.prototype.getClassName=function(){return"HemisphericLight"};b.prototype.setDirectionToTarget=function(a){return this.direction=q.e.Normalize(a.subtract(q.e.Zero()))};b.prototype.getShadowGenerator=function(){return null};
b.prototype.transferToEffect=function(a,b){a=q.e.Normalize(this.direction);this._uniformBuffer.updateFloat4("vLightData",a.x,a.y,a.z,0,b);this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),b);return this};b.prototype.transferToNodeMaterialEffect=function(a,b){var g=q.e.Normalize(this.direction);a.setFloat3(b,g.x,g.y,g.z);return this};b.prototype.computeWorldMatrix=function(){this._worldMatrix||(this._worldMatrix=q.a.Identity());return this._worldMatrix};b.prototype.getTypeID=
function(){return t.a.LIGHTTYPEID_HEMISPHERICLIGHT};b.prototype.prepareLightSpecificDefines=function(a,b){a["HEMILIGHT"+b]=!0};Object(n.c)([Object(e.e)()],b.prototype,"groundColor",void 0);Object(n.c)([Object(e.o)()],b.prototype,"direction",void 0);return b}(t.a)},YbFH:function(r,v,a){var n=a("Xeau"),e=a("aCSs"),q=function(){function a(a,b,p,c,f){this.size=a;this.position=b;this.alphaMode=6;this.color=p||new n.a(1,1,1);this.texture=c?new e.a(c,f.getScene(),!0):null;this._system=f;f.lensFlares.push(this)}
a.AddFlare=function(b,l,p,c,f){return new a(b,l,p,c,f)};a.prototype.dispose=function(){this.texture&&this.texture.dispose();var a=this._system.lensFlares.indexOf(this);this._system.lensFlares.splice(a,1)};return a}(),h=a("YKqZ"),t=a("/SR9"),w=a("sH6m"),m=a("e2Mr"),b=a("y4Ty"),k=a("2/Cc"),u=a("cdI9");a("TEKE");a("Qo/Z");var g=a("n5HA"),y=function(){function a(g,l,p){this.name=g;this.lensFlares=[];this.borderLimit=300;this.viewportBorder=0;this.layerMask=268435455;this._vertexBuffers={};this._isEnabled=
!0;this._scene=p||m.a.LastCreatedScene;a._SceneComponentInitialization(this._scene);this._emitter=l;this.id=g;p.lensFlareSystems.push(this);this.meshesSelectionPredicate=function(c){return p.activeCamera&&c.material&&c.isVisible&&c.isEnabled()&&c.isBlocker&&0!=(c.layerMask&p.activeCamera.layerMask)};g=p.getEngine();l=[];l.push(1,1);l.push(-1,1);l.push(-1,-1);l.push(1,-1);this._vertexBuffers[b.b.PositionKind]=new b.b(g,l,b.b.PositionKind,!1,!1,2);l=[];l.push(0);l.push(1);l.push(2);l.push(0);l.push(2);
l.push(3);this._indexBuffer=g.createIndexBuffer(l);this._effect=g.createEffect("lensFlare",[b.b.PositionKind],["color","viewportMatrix"],["textureSampler"],"")}Object.defineProperty(a.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(a){this._isEnabled=a},enumerable:!1,configurable:!0});a.prototype.getScene=function(){return this._scene};a.prototype.getEmitter=function(){return this._emitter};a.prototype.setEmitter=function(a){this._emitter=a};a.prototype.getEmitterPosition=
function(){return this._emitter.getAbsolutePosition?this._emitter.getAbsolutePosition():this._emitter.position};a.prototype.computeEffectivePosition=function(a){var b=this.getEmitterPosition();b=t.e.Project(b,t.a.Identity(),this._scene.getTransformMatrix(),a);this._positionX=b.x;this._positionY=b.y;b=t.e.TransformCoordinates(this.getEmitterPosition(),this._scene.getViewMatrix());0<this.viewportBorder&&(a.x-=this.viewportBorder,a.y-=this.viewportBorder,a.width+=2*this.viewportBorder,a.height+=2*this.viewportBorder,
b.x+=this.viewportBorder,b.y+=this.viewportBorder,this._positionX+=this.viewportBorder,this._positionY+=this.viewportBorder);return 0<b.z?!0:!1};a.prototype._isVisible=function(){if(!this._isEnabled||!this._scene.activeCamera)return!1;var a=this.getEmitterPosition().subtract(this._scene.activeCamera.globalPosition),b=a.length();a.normalize();a=new k.a(this._scene.activeCamera.globalPosition,a);a=this._scene.pickWithRay(a,this.meshesSelectionPredicate,!0);return!a||!a.hit||a.distance>b};a.prototype.render=
function(){if(!this._effect.isReady()||!this._scene.activeCamera)return!1;var a=this._scene.getEngine(),b=this._scene.activeCamera.viewport.toGlobal(a.getRenderWidth(!0),a.getRenderHeight(!0));if(!this.computeEffectivePosition(b)||!this._isVisible())return!1;var p=this._positionX<this.borderLimit+b.x?this.borderLimit+b.x-this._positionX:this._positionX>b.x+b.width-this.borderLimit?this._positionX-b.x-b.width+this.borderLimit:0;var c=this._positionY<this.borderLimit+b.y?this.borderLimit+b.y-this._positionY:
this._positionY>b.y+b.height-this.borderLimit?this._positionY-b.y-b.height+this.borderLimit:0;p=(p>c?p:c)-this.viewportBorder;p>this.borderLimit&&(p=this.borderLimit);p=1-w.a.Clamp(p/this.borderLimit,0,1);if(0>p)return!1;1<p&&(p=1);0<this.viewportBorder&&(b.x+=this.viewportBorder,b.y+=this.viewportBorder,b.width-=2*this.viewportBorder,b.height-=2*this.viewportBorder,this._positionX-=this.viewportBorder,this._positionY-=this.viewportBorder);c=b.x+b.width/2;var f=b.y+b.height/2,d=c-this._positionX,
g=f-this._positionY;a.enableEffect(this._effect);a.setState(!1);a.setDepthBuffer(!1);a.bindBuffers(this._vertexBuffers,this._indexBuffer,this._effect);for(var e=0;e<this.lensFlares.length;e++){var k=this.lensFlares[e];if(!k.texture||k.texture.isReady()){a.setAlphaMode(k.alphaMode);var h=c-d*k.position,y=f-g*k.position,m=k.size,x=k.size*a.getAspectRatio(this._scene.activeCamera,!0);h=t.a.FromValues(m/2,0,0,0,0,x/2,0,0,0,0,1,0,h/(b.width+2*b.x)*2-1,1-y/(b.height+2*b.y)*2,0,1);this._effect.setMatrix("viewportMatrix",
h);this._effect.setTexture("textureSampler",k.texture);this._effect.setFloat4("color",k.color.r*p,k.color.g*p,k.color.b*p,1);a.drawElementsType(u.a.TriangleFillMode,0,6)}}a.setDepthBuffer(!0);a.setAlphaMode(0);return!0};a.prototype.dispose=function(){var a=this._vertexBuffers[b.b.PositionKind];a&&(a.dispose(),this._vertexBuffers[b.b.PositionKind]=null);this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);for(;this.lensFlares.length;)this.lensFlares[0].dispose();
a=this._scene.lensFlareSystems.indexOf(this);this._scene.lensFlareSystems.splice(a,1)};a.Parse=function(b,g,p){var c=g.getLastEntryByID(b.emitterId),f=b.name||"lensFlareSystem#"+b.emitterId;g=new a(f,c,g);g.id=b.id||f;g.borderLimit=b.borderLimit;for(f=0;f<b.flares.length;f++)c=b.flares[f],q.AddFlare(c.size,c.position,n.a.FromArray(c.color),c.textureName?p+c.textureName:"",g);return g};a.prototype.serialize=function(){var a={};a.id=this.id;a.name=this.name;a.emitterId=this.getEmitter().id;a.borderLimit=
this.borderLimit;a.flares=[];for(var b=0;b<this.lensFlares.length;b++){var g=this.lensFlares[b];a.flares.push({size:g.size,position:g.position,color:g.color.asArray(),textureName:h.b.GetFilename(g.texture?g.texture.name:"")})}return a};a._SceneComponentInitialization=function(a){throw g.a.WarnImport("LensFlareSystemSceneComponent");};return a}(),x=a("Yap0");r=a("KbzI");r.a.AddParser(x.a.NAME_LENSFLARESYSTEM,function(a,b,g,p){if(void 0!==a.lensFlareSystems&&null!==a.lensFlareSystems){g.lensFlareSystems||
(g.lensFlareSystems=[]);for(var c=0,f=a.lensFlareSystems.length;c<f;c++){var d=y.Parse(a.lensFlareSystems[c],b,p);g.lensFlareSystems.push(d)}}});r.a.prototype.getLensFlareSystemByName=function(a){for(var b=0;b<this.lensFlareSystems.length;b++)if(this.lensFlareSystems[b].name===a)return this.lensFlareSystems[b];return null};r.a.prototype.getLensFlareSystemByID=function(a){for(var b=0;b<this.lensFlareSystems.length;b++)if(this.lensFlareSystems[b].id===a)return this.lensFlareSystems[b];return null};
r.a.prototype.removeLensFlareSystem=function(a){a=this.lensFlareSystems.indexOf(a);-1!==a&&this.lensFlareSystems.splice(a,1);return a};r.a.prototype.addLensFlareSystem=function(a){this.lensFlareSystems.push(a)};var B=function(){function a(a){this.name=x.a.NAME_LENSFLARESYSTEM;this.scene=a;a.lensFlareSystems=[]}a.prototype.register=function(){this.scene._afterCameraDrawStage.registerStep(x.a.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM,this,this._draw)};a.prototype.rebuild=function(){};a.prototype.addFromContainer=
function(a){var b=this;a.lensFlareSystems&&a.lensFlareSystems.forEach(function(a){b.scene.addLensFlareSystem(a)})};a.prototype.removeFromContainer=function(a,b){var g=this;a.lensFlareSystems&&a.lensFlareSystems.forEach(function(a){g.scene.removeLensFlareSystem(a);b&&a.dispose()})};a.prototype.serialize=function(a){a.lensFlareSystems=[];for(var b=0,g=this.scene.lensFlareSystems;b<g.length;b++)a.lensFlareSystems.push(g[b].serialize())};a.prototype.dispose=function(){for(var a=this.scene.lensFlareSystems;a.length;)a[0].dispose()};
a.prototype._draw=function(a){if(this.scene.lensFlaresEnabled){var b=this.scene.lensFlareSystems;h.b.StartPerformanceCounter("Lens flares",0<b.length);for(var g=0;g<b.length;g++){var c=b[g];0!==(a.layerMask&c.layerMask)&&c.render()}h.b.EndPerformanceCounter("Lens flares",0<b.length)}};return a}();y._SceneComponentInitialization=function(a){var b=a._getComponent(x.a.NAME_LENSFLARESYSTEM);b||(b=new B(a),a._addComponent(b))}},fqU1:function(r,v,a){a.d(v,"a",function(){return t});var n=a("oYeq"),e=a("ADVu"),
q=a("/SR9");r=a("llUH");var h=a("SYzJ"),t=function(a){function m(){var b=null!==a&&a.apply(this,arguments)||this;b._needProjectionMatrixCompute=!0;return b}Object(n.d)(m,a);m.prototype._setPosition=function(a){this._position=a};Object.defineProperty(m.prototype,"position",{get:function(){return this._position},set:function(a){this._setPosition(a)},enumerable:!1,configurable:!0});m.prototype._setDirection=function(a){this._direction=a};Object.defineProperty(m.prototype,"direction",{get:function(){return this._direction},
set:function(a){this._setDirection(a)},enumerable:!1,configurable:!0});Object.defineProperty(m.prototype,"shadowMinZ",{get:function(){return this._shadowMinZ},set:function(a){this._shadowMinZ=a;this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0});Object.defineProperty(m.prototype,"shadowMaxZ",{get:function(){return this._shadowMaxZ},set:function(a){this._shadowMaxZ=a;this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0});m.prototype.computeTransformedInformation=function(){return this.parent&&
this.parent.getWorldMatrix?(this.transformedPosition||(this.transformedPosition=q.e.Zero()),q.e.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=q.e.Zero()),q.e.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),!0):!1};m.prototype.getDepthScale=function(){return 50};m.prototype.getShadowDirection=function(a){return this.transformedDirection?
this.transformedDirection:this.direction};m.prototype.getAbsolutePosition=function(){return this.transformedPosition?this.transformedPosition:this.position};m.prototype.setDirectionToTarget=function(a){return this.direction=q.e.Normalize(a.subtract(this.position))};m.prototype.getRotation=function(){this.direction.normalize();var a=q.e.Cross(this.direction,h.a.Y),k=q.e.Cross(a,this.direction);return q.e.RotationFromAxis(a,k,this.direction)};m.prototype.needCube=function(){return!1};m.prototype.needProjectionMatrixCompute=
function(){return this._needProjectionMatrixCompute};m.prototype.forceProjectionMatrixCompute=function(){this._needProjectionMatrixCompute=!0};m.prototype._initCache=function(){a.prototype._initCache.call(this);this._cache.position=q.e.Zero()};m.prototype._isSynchronized=function(){return this._cache.position.equals(this.position)?!0:!1};m.prototype.computeWorldMatrix=function(a){if(!a&&this.isSynchronized())return this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix;this._updateCache();
this._cache.position.copyFrom(this.position);this._worldMatrix||(this._worldMatrix=q.a.Identity());q.a.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix);this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent());this._worldMatrixDeterminantIsDirty=!0;return this._worldMatrix};m.prototype.getDepthMinZ=function(a){return void 0!==this.shadowMinZ?this.shadowMinZ:a.minZ};m.prototype.getDepthMaxZ=
function(a){return void 0!==this.shadowMaxZ?this.shadowMaxZ:a.maxZ};m.prototype.setShadowProjectionMatrix=function(a,k,e){this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(k,e,a):this._setDefaultShadowProjectionMatrix(a,k,e);return this};Object(n.c)([Object(e.o)()],m.prototype,"position",null);Object(n.c)([Object(e.o)()],m.prototype,"direction",null);Object(n.c)([Object(e.c)()],m.prototype,"shadowMinZ",null);Object(n.c)([Object(e.c)()],m.prototype,"shadowMaxZ",null);return m}(r.a)},
itUE:function(r,v,a){a.d(v,"a",function(){return l});var n=a("oYeq"),e=a("/SR9"),q=a("Xeau"),h=a("y4Ty"),t=a("llUH"),w=a("/eyM"),m=a("aCSs"),b=a("srWW"),k=a("OJ6t"),u=a("AGTA");a("IS0N");a("QcF5");a("8uwT");a("Y/c4");var g=a("ps+7"),y=a("n5HA"),x=a("UpSL"),B=a("F24J"),C=new e.a,A=new e.a,l=function(){function a(c,f,d){this.onBeforeShadowMapRenderObservable=new g.a;this.onAfterShadowMapRenderObservable=new g.a;this.onBeforeShadowMapRenderMeshObservable=new g.a;this.onAfterShadowMapRenderMeshObservable=
new g.a;this._bias=5E-5;this._normalBias=0;this._blurBoxOffset=1;this._blurScale=2;this._blurKernel=1;this._useKernelBlur=!1;this._filter=a.FILTER_NONE;this._filteringQuality=a.QUALITY_HIGH;this._contactHardeningLightSizeUVRatio=.1;this._darkness=0;this.enableSoftTransparentShadow=this._transparencyShadow=!1;this.frustumEdgeFalloff=0;this.forceBackFacesOnly=!1;this._lightDirection=e.e.Zero();this._viewMatrix=e.a.Zero();this._projectionMatrix=e.a.Zero();this._transformMatrix=e.a.Zero();this._cachedPosition=
new e.e(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);this._cachedDirection=new e.e(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);this._currentFaceIndexCache=this._currentFaceIndex=0;this._defaultTextureMatrix=e.a.Identity();this._mapSize=c;this._light=f;this._scene=f.getScene();f._shadowGenerator=this;this.id=f.id;a._SceneComponentInitialization(this._scene);c=this._scene.getEngine().getCaps();this._textureType=d?c.textureFloatRender&&c.textureFloatLinearFiltering?1:c.textureHalfFloatRender&&
c.textureHalfFloatLinearFiltering?2:0:c.textureHalfFloatRender&&c.textureHalfFloatLinearFiltering?2:c.textureFloatRender&&c.textureFloatLinearFiltering?1:0;this._initializeGenerator();this._applyFilterValues()}Object.defineProperty(a.prototype,"bias",{get:function(){return this._bias},set:function(a){this._bias=a},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"normalBias",{get:function(){return this._normalBias},set:function(a){this._normalBias=a},enumerable:!1,configurable:!0});
Object.defineProperty(a.prototype,"blurBoxOffset",{get:function(){return this._blurBoxOffset},set:function(a){this._blurBoxOffset!==a&&(this._blurBoxOffset=a,this._disposeBlurPostProcesses())},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"blurScale",{get:function(){return this._blurScale},set:function(a){this._blurScale!==a&&(this._blurScale=a,this._disposeBlurPostProcesses())},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"blurKernel",{get:function(){return this._blurKernel},
set:function(a){this._blurKernel!==a&&(this._blurKernel=a,this._disposeBlurPostProcesses())},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"useKernelBlur",{get:function(){return this._useKernelBlur},set:function(a){this._useKernelBlur!==a&&(this._useKernelBlur=a,this._disposeBlurPostProcesses())},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"depthScale",{get:function(){return void 0!==this._depthScale?this._depthScale:this._light.getDepthScale()},set:function(a){this._depthScale=
a},enumerable:!1,configurable:!0});a.prototype._validateFilter=function(a){return a};Object.defineProperty(a.prototype,"filter",{get:function(){return this._filter},set:function(c){c=this._validateFilter(c);if(this._light.needCube()){if(c===a.FILTER_BLUREXPONENTIALSHADOWMAP){this.useExponentialShadowMap=!0;return}if(c===a.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP){this.useCloseExponentialShadowMap=!0;return}if(c===a.FILTER_PCF||c===a.FILTER_PCSS){this.usePoissonSampling=!0;return}}c!==a.FILTER_PCF&&c!==
a.FILTER_PCSS||1!==this._scene.getEngine().webGLVersion?this._filter!==c&&(this._filter=c,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty()):this.usePoissonSampling=!0},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"usePoissonSampling",{get:function(){return this.filter===a.FILTER_POISSONSAMPLING},set:function(c){var f=this._validateFilter(a.FILTER_POISSONSAMPLING);if(c||this.filter===a.FILTER_POISSONSAMPLING)this.filter=c?f:a.FILTER_NONE},
enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"useExponentialShadowMap",{get:function(){return this.filter===a.FILTER_EXPONENTIALSHADOWMAP},set:function(c){var f=this._validateFilter(a.FILTER_EXPONENTIALSHADOWMAP);if(c||this.filter===a.FILTER_EXPONENTIALSHADOWMAP)this.filter=c?f:a.FILTER_NONE},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"useBlurExponentialShadowMap",{get:function(){return this.filter===a.FILTER_BLUREXPONENTIALSHADOWMAP},set:function(c){var f=
this._validateFilter(a.FILTER_BLUREXPONENTIALSHADOWMAP);if(c||this.filter===a.FILTER_BLUREXPONENTIALSHADOWMAP)this.filter=c?f:a.FILTER_NONE},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"useCloseExponentialShadowMap",{get:function(){return this.filter===a.FILTER_CLOSEEXPONENTIALSHADOWMAP},set:function(c){var f=this._validateFilter(a.FILTER_CLOSEEXPONENTIALSHADOWMAP);if(c||this.filter===a.FILTER_CLOSEEXPONENTIALSHADOWMAP)this.filter=c?f:a.FILTER_NONE},enumerable:!1,configurable:!0});
Object.defineProperty(a.prototype,"useBlurCloseExponentialShadowMap",{get:function(){return this.filter===a.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP},set:function(c){var f=this._validateFilter(a.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);if(c||this.filter===a.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)this.filter=c?f:a.FILTER_NONE},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"usePercentageCloserFiltering",{get:function(){return this.filter===a.FILTER_PCF},set:function(c){var f=this._validateFilter(a.FILTER_PCF);
if(c||this.filter===a.FILTER_PCF)this.filter=c?f:a.FILTER_NONE},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"filteringQuality",{get:function(){return this._filteringQuality},set:function(a){this._filteringQuality!==a&&(this._filteringQuality=a,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"useContactHardeningShadow",{get:function(){return this.filter===a.FILTER_PCSS},
set:function(c){var f=this._validateFilter(a.FILTER_PCSS);if(c||this.filter===a.FILTER_PCSS)this.filter=c?f:a.FILTER_NONE},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"contactHardeningLightSizeUVRatio",{get:function(){return this._contactHardeningLightSizeUVRatio},set:function(a){this._contactHardeningLightSizeUVRatio=a},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"darkness",{get:function(){return this._darkness},set:function(a){this.setDarkness(a)},enumerable:!1,
configurable:!0});a.prototype.getDarkness=function(){return this._darkness};a.prototype.setDarkness=function(a){this._darkness=1<=a?1:0>=a?0:a;return this};Object.defineProperty(a.prototype,"transparencyShadow",{get:function(){return this._transparencyShadow},set:function(a){this.setTransparencyShadow(a)},enumerable:!1,configurable:!0});a.prototype.setTransparencyShadow=function(a){this._transparencyShadow=a;return this};a.prototype.getShadowMap=function(){return this._shadowMap};a.prototype.getShadowMapForRendering=
function(){return this._shadowMap2?this._shadowMap2:this._shadowMap};a.prototype.getClassName=function(){return a.CLASSNAME};a.prototype.addShadowCaster=function(a,f){var c;void 0===f&&(f=!0);if(!this._shadowMap)return this;this._shadowMap.renderList||(this._shadowMap.renderList=[]);this._shadowMap.renderList.push(a);f&&(c=this._shadowMap.renderList).push.apply(c,a.getChildMeshes());return this};a.prototype.removeShadowCaster=function(a,f){void 0===f&&(f=!0);if(!this._shadowMap||!this._shadowMap.renderList)return this;
var c=this._shadowMap.renderList.indexOf(a);-1!==c&&this._shadowMap.renderList.splice(c,1);if(f)for(f=0,a=a.getChildren();f<a.length;f++)this.removeShadowCaster(a[f]);return this};a.prototype.getLight=function(){return this._light};Object.defineProperty(a.prototype,"mapSize",{get:function(){return this._mapSize},set:function(a){this._mapSize=a;this._light._markMeshesAsLightDirty();this.recreateShadowMap()},enumerable:!1,configurable:!0});a.prototype._initializeGenerator=function(){this._light._markMeshesAsLightDirty();
this._initializeShadowMap()};a.prototype._createTargetRenderTexture=function(){1<this._scene.getEngine().webGLVersion?(this._shadowMap=new b.a(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1),this._shadowMap.createDepthStencilTexture(513,!0)):this._shadowMap=new b.a(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube())};a.prototype._initializeShadowMap=function(){var c=this;this._createTargetRenderTexture();
if(null!==this._shadowMap){this._shadowMap.wrapU=m.a.CLAMP_ADDRESSMODE;this._shadowMap.wrapV=m.a.CLAMP_ADDRESSMODE;this._shadowMap.anisotropicFilteringLevel=1;this._shadowMap.updateSamplingMode(m.a.BILINEAR_SAMPLINGMODE);this._shadowMap.renderParticles=!1;this._shadowMap.ignoreCameraViewport=!0;this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId);this._shadowMap.customRenderFunction=this._renderForShadowMap.bind(this);this._shadowMap.customIsReadyFunction=function(a,c){return!0};
var f=this._scene.getEngine();this._shadowMap.onBeforeRenderObservable.add(function(d){c._currentFaceIndex=d;c._filter===a.FILTER_PCF&&f.setColorWrite(!1);c._scene.getSceneUniformBuffer().useUbo&&(d=c._scene.getSceneUniformBuffer(),d.updateMatrix("viewProjection",c.getTransformMatrix()),d.updateMatrix("view",c._viewMatrix),d.update())});this._shadowMap.onAfterUnbindObservable.add(function(){if(c._scene.getSceneUniformBuffer().useUbo){var d=c._scene.getSceneUniformBuffer();d.updateMatrix("viewProjection",
c._scene.getTransformMatrix());d.updateMatrix("view",c._scene.getViewMatrix());d.update()}c._filter===a.FILTER_PCF&&f.setColorWrite(!0);if(c.useBlurExponentialShadowMap||c.useBlurCloseExponentialShadowMap)if(d=c.getShadowMapForRendering())d=d.getInternalTexture(),c._scene.postProcessManager.directRender(c._blurPostProcesses,d,!0),f.unBindFramebuffer(d,!0)});var d=new q.b(0,0,0,0),b=new q.b(1,1,1,1);this._shadowMap.onClearObservable.add(function(f){c._filter===a.FILTER_PCF?f.clear(b,!1,!0,!1):c.useExponentialShadowMap||
c.useBlurExponentialShadowMap?f.clear(d,!0,!0,!1):f.clear(b,!0,!0,!1)});this._shadowMap.onResizeObservable.add(function(a){c._storedUniqueId=c._shadowMap.uniqueId;c._mapSize=a.getRenderSize();c._light._markMeshesAsLightDirty();c.recreateShadowMap()});for(var g=B.a.MIN_RENDERINGGROUPS;g<B.a.MAX_RENDERINGGROUPS;g++)this._shadowMap.setRenderingAutoClearDepthStencil(g,!1)}};a.prototype._initializeBlurRTTAndPostProcesses=function(){var a=this,f=this._scene.getEngine(),d=this._mapSize/this.blurScale;this.useKernelBlur&&
1===this.blurScale||(this._shadowMap2=new b.a(this._light.name+"_shadowMap2",d,this._scene,!1,!0,this._textureType),this._shadowMap2.wrapU=m.a.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=m.a.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(m.a.BILINEAR_SAMPLINGMODE));this.useKernelBlur?(this._kernelBlurXPostprocess=new u.a(this._light.name+"KernelBlurX",new e.d(1,0),this.blurKernel,1,null,m.a.BILINEAR_SAMPLINGMODE,f,!1,this._textureType),this._kernelBlurXPostprocess.width=d,this._kernelBlurXPostprocess.height=
d,this._kernelBlurXPostprocess.onApplyObservable.add(function(c){c.setTexture("textureSampler",a._shadowMap)}),this._kernelBlurYPostprocess=new u.a(this._light.name+"KernelBlurY",new e.d(0,1),this.blurKernel,1,null,m.a.BILINEAR_SAMPLINGMODE,f,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,0===this._textureType&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,
this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new k.a(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,m.a.BILINEAR_SAMPLINGMODE,f,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType),this._boxBlurPostprocess.onApplyObservable.add(function(c){c.setFloat2("screenSize",d,d);c.setTexture("textureSampler",a._shadowMap)}),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])};a.prototype._renderForShadowMap=function(a,
f,d,b){var c,g=this._scene.getEngine(),k=g.getColorWrite();if(b.length){g.setColorWrite(!1);for(c=0;c<b.length;c++)this._renderSubMeshForShadowMap(b.data[c]);g.setColorWrite(k)}for(c=0;c<a.length;c++)this._renderSubMeshForShadowMap(a.data[c]);for(c=0;c<f.length;c++)this._renderSubMeshForShadowMap(f.data[c]);if(this._transparencyShadow)for(c=0;c<d.length;c++)this._renderSubMeshForShadowMap(d.data[c],!0);else for(c=0;c<d.length;c++)d.data[c].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=
!1};a.prototype._bindCustomEffectForRenderSubMeshForShadowMap=function(a,f,d,b){var c,g,k,l,e,h;f.setMatrix(null!==(c=null===d||void 0===d?void 0:d.viewProjection)&&void 0!==c?c:"viewProjection",this.getTransformMatrix());f.setMatrix(null!==(g=null===d||void 0===d?void 0:d.view)&&void 0!==g?g:"view",this._viewMatrix);f.setMatrix(null!==(k=null===d||void 0===d?void 0:d.projection)&&void 0!==k?k:"projection",this._projectionMatrix);a=b.getWorldMatrix();f.setMatrix(null!==(l=null===d||void 0===d?void 0:
d.world)&&void 0!==l?l:"world",a);a.multiplyToRef(this.getTransformMatrix(),C);f.setMatrix(null!==(e=null===d||void 0===d?void 0:d.worldViewProjection)&&void 0!==e?e:"worldViewProjection",C);a.multiplyToRef(this._viewMatrix,A);f.setMatrix(null!==(h=null===d||void 0===d?void 0:d.worldView)&&void 0!==h?h:"worldView",A)};a.prototype._renderSubMeshForShadowMap=function(a,f){var c,b;void 0===f&&(f=!1);var g=a.getRenderingMesh(),k=a.getEffectiveMesh(),l=this._scene,e=l.getEngine(),h=a.getMaterial();k._internalAbstractMeshDataInfo._isActiveIntermediate=
!1;if(h&&0!==a.verticesCount&&a._renderId!==l.getRenderId()){e.setState(h.backFaceCulling);var u=g._getInstancesRenderList(a._id,!!a.getReplacementMesh());if(!u.mustReturn){var p=e.getCaps().instancedArrays&&(null!==u.visibleInstances[a._id]&&void 0!==u.visibleInstances[a._id]||g.hasThinInstances);if(!this.customAllowRendering||this.customAllowRendering(a))if(this.isReady(a,p,f)){a._renderId=l.getRenderId();var y=null===(c=g.material)||void 0===c?void 0:c.shadowDepthWrapper,m=null!==(b=null===y||
void 0===y?void 0:y.getEffect(a,this))&&void 0!==b?b:this._effect;e.enableEffect(m);g._bind(a,m,h.fillMode);this.getTransformMatrix();m.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale);this.getLight().getTypeID()===t.a.LIGHTTYPEID_DIRECTIONALLIGHT?m.setVector3("lightDataSM",this._cachedDirection):m.setVector3("lightDataSM",this._cachedPosition);l.activeCamera&&m.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(l.activeCamera),this.getLight().getDepthMinZ(l.activeCamera)+
this.getLight().getDepthMaxZ(l.activeCamera));f&&this.enableSoftTransparentShadow&&m.setFloat("softTransparentShadowSM",k.visibility);if(y)a._effectOverride=m,y.standalone?y.baseMaterial.bindForSubMesh(k.getWorldMatrix(),g,a):h.bindForSubMesh(k.getWorldMatrix(),g,a),a._effectOverride=null;else{m.setMatrix("viewProjection",this.getTransformMatrix());h&&h.needAlphaTesting()&&(f=h.getAlphaTestTexture())&&(m.setTexture("diffuseSampler",f),m.setMatrix("diffuseMatrix",f.getTextureMatrix()||this._defaultTextureMatrix));
if(g.useBones&&g.computeBonesUsingShaders&&g.skeleton)if(f=g.skeleton,f.isUsingTextureForMatrices){c=f.getTransformMatrixTexture(g);if(!c)return;m.setTexture("boneSampler",c);m.setFloat("boneTextureWidth",4*(f.bones.length+1))}else m.setMatrices("mBones",f.getTransformMatrices(g));w.a.BindMorphTargetParameters(g,m);w.a.BindClipPlane(m,l)}this._bindCustomEffectForRenderSubMeshForShadowMap(a,m,null===y||void 0===y?void 0:y._matriceNames,k);this.forceBackFacesOnly&&e.setState(!0,0,!1,!0);this.onBeforeShadowMapRenderMeshObservable.notifyObservers(g);
this.onBeforeShadowMapRenderObservable.notifyObservers(m);g._processRendering(k,a,m,h.fillMode,u,p,function(a,c){return m.setMatrix("world",c)});this.forceBackFacesOnly&&e.setState(!0,0,!1,!1);this.onAfterShadowMapRenderObservable.notifyObservers(m);this.onAfterShadowMapRenderMeshObservable.notifyObservers(g)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}}};a.prototype._applyFilterValues=function(){this._shadowMap&&(this.filter===a.FILTER_NONE||this.filter===a.FILTER_PCSS?this._shadowMap.updateSamplingMode(m.a.NEAREST_SAMPLINGMODE):
this._shadowMap.updateSamplingMode(m.a.BILINEAR_SAMPLINGMODE))};a.prototype.forceCompilation=function(a,b){var c=this,f=Object(n.a)({useInstances:!1},b);if(b=this.getShadowMap())if(b=b.renderList){for(var g=[],k=0;k<b.length;k++)g.push.apply(g,b[k].subMeshes);if(0===g.length)a&&a(this);else{var l=0,e=function(){var d,b;if(c._scene&&c._scene.getEngine()){for(;c.isReady(g[l],f.useInstances,null!==(b=null===(d=g[l].getMaterial())||void 0===d?void 0:d.needAlphaBlendingForMesh(g[l].getMesh()))&&void 0!==
b?b:!1);)if(l++,l>=g.length){a&&a(c);return}setTimeout(e,16)}};e()}}else a&&a(this);else a&&a(this)};a.prototype.forceCompilationAsync=function(a){var c=this;return new Promise(function(d){c.forceCompilation(function(){d()},a)})};a.prototype._isReadyCustomDefines=function(a,b,d){};a.prototype._prepareShadowDefines=function(a,b,d,g){d.push("#define SM_FLOAT "+(0!==this._textureType?"1":"0"));d.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0"));d.push("#define SM_DEPTHTEXTURE "+
(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));var c=a.getMesh();d.push("#define SM_NORMALBIAS "+(this.normalBias&&c.isVerticesDataPresent(h.b.NormalKind)?"1":"0"));d.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===t.a.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0"));d.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0"));d.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&g?"1":"0"));this._isReadyCustomDefines(d,a,b);
return d};a.prototype.isReady=function(a,b,d){var c=a.getMaterial(),f=null===c||void 0===c?void 0:c.shadowDepthWrapper,g=[];this._prepareShadowDefines(a,b,g,d);if(f){if(!f.isReadyForSubMesh(a,g,this,b))return!1}else{d=[h.b.PositionKind];var k=a.getMesh();this.normalBias&&k.isVerticesDataPresent(h.b.NormalKind)&&(d.push(h.b.NormalKind),g.push("#define NORMAL"),k.nonUniformScaling&&g.push("#define NONUNIFORMSCALING"));if(c&&c.needAlphaTesting()&&(c=c.getAlphaTestTexture())){if(!c.isReady())return!1;
g.push("#define ALPHATEST");k.isVerticesDataPresent(h.b.UVKind)&&(d.push(h.b.UVKind),g.push("#define UV1"));k.isVerticesDataPresent(h.b.UV2Kind)&&1===c.coordinatesIndex&&(d.push(h.b.UV2Kind),g.push("#define UV2"))}c=new x.a;k.useBones&&k.computeBonesUsingShaders&&k.skeleton?(d.push(h.b.MatricesIndicesKind),d.push(h.b.MatricesWeightsKind),4<k.numBoneInfluencers&&(d.push(h.b.MatricesIndicesExtraKind),d.push(h.b.MatricesWeightsExtraKind)),f=k.skeleton,g.push("#define NUM_BONE_INFLUENCERS "+k.numBoneInfluencers),
0<k.numBoneInfluencers&&c.addCPUSkinningFallback(0,k),f.isUsingTextureForMatrices?g.push("#define BONETEXTURE"):g.push("#define BonesPerMesh "+(f.bones.length+1))):g.push("#define NUM_BONE_INFLUENCERS 0");var l=k.morphTargetManager;f=0;l&&0<l.numInfluencers&&(g.push("#define MORPHTARGETS"),f=l.numInfluencers,g.push("#define NUM_MORPH_INFLUENCERS "+f),w.a.PrepareAttributesForMorphTargetsInfluencers(d,k,f));k=this._scene;k.clipPlane&&g.push("#define CLIPPLANE");k.clipPlane2&&g.push("#define CLIPPLANE2");
k.clipPlane3&&g.push("#define CLIPPLANE3");k.clipPlane4&&g.push("#define CLIPPLANE4");k.clipPlane5&&g.push("#define CLIPPLANE5");k.clipPlane6&&g.push("#define CLIPPLANE6");b&&(g.push("#define INSTANCES"),w.a.PushAttributesForInstances(d),a.getRenderingMesh().hasThinInstances&&g.push("#define THIN_INSTANCES"));if(this.customShaderOptions&&this.customShaderOptions.defines)for(a=0,b=this.customShaderOptions.defines;a<b.length;a++)k=b[a],-1===g.indexOf(k)&&g.push(k);g=g.join("\n");if(this._cachedDefines!==
g){this._cachedDefines=g;a="shadowMap";b="world mBones viewProjection diffuseMatrix lightDataSM depthValuesSM biasAndScaleSM morphTargetInfluences boneTextureWidth vClipPlane vClipPlane2 vClipPlane3 vClipPlane4 vClipPlane5 vClipPlane6 softTransparentShadowSM".split(" ");k=["diffuseSampler","boneSampler"];if(this.customShaderOptions){a=this.customShaderOptions.shaderName;if(this.customShaderOptions.attributes){l=0;for(var e=this.customShaderOptions.attributes;l<e.length;l++){var u=e[l];-1===d.indexOf(u)&&
d.push(u)}}if(this.customShaderOptions.uniforms)for(l=0,e=this.customShaderOptions.uniforms;l<e.length;l++)u=e[l],-1===b.indexOf(u)&&b.push(u);if(this.customShaderOptions.samplers)for(l=0,e=this.customShaderOptions.samplers;l<e.length;l++)u=e[l],-1===k.indexOf(u)&&k.push(u)}this._effect=this._scene.getEngine().createEffect(a,d,b,k,g,c,void 0,void 0,{maxSimultaneousMorphTargets:f})}if(!this._effect.isReady())return!1}if(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)this._blurPostProcesses&&
this._blurPostProcesses.length||this._initializeBlurRTTAndPostProcesses();return this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady()||this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady()||this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady()?!1:!0};a.prototype.prepareDefines=function(c,b){var d=this._light;if(this._scene.shadowsEnabled&&d.shadowEnabled){c["SHADOW"+b]=!0;if(this.useContactHardeningShadow)c["SHADOWPCSS"+b]=!0,this._filteringQuality===a.QUALITY_LOW?
c["SHADOWLOWQUALITY"+b]=!0:this._filteringQuality===a.QUALITY_MEDIUM&&(c["SHADOWMEDIUMQUALITY"+b]=!0);else if(this.usePercentageCloserFiltering)c["SHADOWPCF"+b]=!0,this._filteringQuality===a.QUALITY_LOW?c["SHADOWLOWQUALITY"+b]=!0:this._filteringQuality===a.QUALITY_MEDIUM&&(c["SHADOWMEDIUMQUALITY"+b]=!0);else if(this.usePoissonSampling)c["SHADOWPOISSON"+b]=!0;else if(this.useExponentialShadowMap||this.useBlurExponentialShadowMap)c["SHADOWESM"+b]=!0;else if(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)c["SHADOWCLOSEESM"+
b]=!0;d.needCube()&&(c["SHADOWCUBE"+b]=!0)}};a.prototype.bindShadowLight=function(c,b){var d=this._light,f=this._scene;if(f.shadowsEnabled&&d.shadowEnabled&&(f=f.activeCamera)){var g=this.getShadowMap();g&&(d.needCube()||b.setMatrix("lightMatrix"+c,this.getTransformMatrix()),this._filter===a.FILTER_PCF?(b.setDepthStencilTexture("shadowSampler"+c,this.getShadowMapForRendering()),d._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),g.getSize().width,1/g.getSize().width,this.frustumEdgeFalloff,
c)):this._filter===a.FILTER_PCSS?(b.setDepthStencilTexture("shadowSampler"+c,this.getShadowMapForRendering()),b.setTexture("depthSampler"+c,this.getShadowMapForRendering()),d._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/g.getSize().width,this._contactHardeningLightSizeUVRatio*g.getSize().width,this.frustumEdgeFalloff,c)):(b.setTexture("shadowSampler"+c,this.getShadowMapForRendering()),d._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/g.getSize().width,
this.depthScale,this.frustumEdgeFalloff,c)),d._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(f),this.getLight().getDepthMinZ(f)+this.getLight().getDepthMaxZ(f),c))}};a.prototype.getTransformMatrix=function(){var a=this._scene;if(this._currentRenderID===a.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderID=a.getRenderId();this._currentFaceIndexCache=this._currentFaceIndex;a=this._light.position;this._light.computeTransformedInformation()&&
(a=this._light.transformedPosition);e.e.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection);1===Math.abs(e.e.Dot(this._lightDirection,e.e.Up()))&&(this._lightDirection.z=1E-13);!this._light.needProjectionMatrixCompute()&&this._cachedPosition&&this._cachedDirection&&a.equals(this._cachedPosition)&&this._lightDirection.equals(this._cachedDirection)||(this._cachedPosition.copyFrom(a),this._cachedDirection.copyFrom(this._lightDirection),e.a.LookAtLHToRef(a,a.add(this._lightDirection),
e.e.Up(),this._viewMatrix),(a=this.getShadowMap())&&(a=a.renderList)&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,a),this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix));return this._transformMatrix};a.prototype.recreateShadowMap=function(){var a=this._shadowMap;a&&(a=a.renderList,this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this.filter,this._applyFilterValues(),this._shadowMap.renderList=a)};a.prototype._disposeBlurPostProcesses=
function(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null);this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null);this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null);this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null);this._blurPostProcesses=[]};a.prototype._disposeRTTandPostProcesses=function(){this._shadowMap&&(this._shadowMap.dispose(),
this._shadowMap=null);this._disposeBlurPostProcesses()};a.prototype.dispose=function(){this._disposeRTTandPostProcesses();this._light&&(this._light._shadowGenerator=null,this._light._markMeshesAsLightDirty());this.onBeforeShadowMapRenderMeshObservable.clear();this.onBeforeShadowMapRenderObservable.clear();this.onAfterShadowMapRenderMeshObservable.clear();this.onAfterShadowMapRenderObservable.clear()};a.prototype.serialize=function(){var a={},b=this.getShadowMap();if(!b)return a;a.className=this.getClassName();
a.lightId=this._light.id;a.id=this._light.id;a.mapSize=b.getRenderSize();a.forceBackFacesOnly=this.forceBackFacesOnly;a.darkness=this.getDarkness();a.transparencyShadow=this._transparencyShadow;a.frustumEdgeFalloff=this.frustumEdgeFalloff;a.bias=this.bias;a.normalBias=this.normalBias;a.usePercentageCloserFiltering=this.usePercentageCloserFiltering;a.useContactHardeningShadow=this.useContactHardeningShadow;a.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio;a.filteringQuality=
this.filteringQuality;a.useExponentialShadowMap=this.useExponentialShadowMap;a.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap;a.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap;a.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap;a.usePoissonSampling=this.usePoissonSampling;a.depthScale=this.depthScale;a.blurBoxOffset=this.blurBoxOffset;a.blurKernel=this.blurKernel;a.blurScale=this.blurScale;a.useKernelBlur=this.useKernelBlur;a.renderList=[];if(b.renderList)for(var d=
0;d<b.renderList.length;d++)a.renderList.push(b.renderList[d].id);return a};a.Parse=function(c,b,d){var f=b.getLightByID(c.lightId);d=d?d(c.mapSize,f):new a(c.mapSize,f);var g=d.getShadowMap();for(f=0;f<c.renderList.length;f++)b.getMeshesByID(c.renderList[f]).forEach(function(a){g&&(g.renderList||(g.renderList=[]),g.renderList.push(a))});void 0!==c.id&&(d.id=c.id);d.forceBackFacesOnly=!!c.forceBackFacesOnly;void 0!==c.darkness&&d.setDarkness(c.darkness);c.transparencyShadow&&d.setTransparencyShadow(!0);
void 0!==c.frustumEdgeFalloff&&(d.frustumEdgeFalloff=c.frustumEdgeFalloff);void 0!==c.bias&&(d.bias=c.bias);void 0!==c.normalBias&&(d.normalBias=c.normalBias);c.usePercentageCloserFiltering?d.usePercentageCloserFiltering=!0:c.useContactHardeningShadow?d.useContactHardeningShadow=!0:c.usePoissonSampling?d.usePoissonSampling=!0:c.useExponentialShadowMap?d.useExponentialShadowMap=!0:c.useBlurExponentialShadowMap?d.useBlurExponentialShadowMap=!0:c.useCloseExponentialShadowMap?d.useCloseExponentialShadowMap=
!0:c.useBlurCloseExponentialShadowMap?d.useBlurCloseExponentialShadowMap=!0:c.useVarianceShadowMap?d.useExponentialShadowMap=!0:c.useBlurVarianceShadowMap&&(d.useBlurExponentialShadowMap=!0);void 0!==c.contactHardeningLightSizeUVRatio&&(d.contactHardeningLightSizeUVRatio=c.contactHardeningLightSizeUVRatio);void 0!==c.filteringQuality&&(d.filteringQuality=c.filteringQuality);c.depthScale&&(d.depthScale=c.depthScale);c.blurScale&&(d.blurScale=c.blurScale);c.blurBoxOffset&&(d.blurBoxOffset=c.blurBoxOffset);
c.useKernelBlur&&(d.useKernelBlur=c.useKernelBlur);c.blurKernel&&(d.blurKernel=c.blurKernel);return d};a.CLASSNAME="ShadowGenerator";a.FILTER_NONE=0;a.FILTER_EXPONENTIALSHADOWMAP=1;a.FILTER_POISSONSAMPLING=2;a.FILTER_BLUREXPONENTIALSHADOWMAP=3;a.FILTER_CLOSEEXPONENTIALSHADOWMAP=4;a.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5;a.FILTER_PCF=6;a.FILTER_PCSS=7;a.QUALITY_HIGH=0;a.QUALITY_MEDIUM=1;a.QUALITY_LOW=2;a._SceneComponentInitialization=function(a){throw y.a.WarnImport("ShadowGeneratorSceneComponent");
};return a}()},lFBE:function(r,v,a){a.d(v,"a",function(){return t});var n=a("oYeq"),e=a("ADVu"),q=a("/SR9");r=a("Ufda");var h=a("llUH");a=a("fqU1");r.a.AddNodeConstructor("Light_Type_1",function(a,e){return function(){return new t(a,q.e.Zero(),e)}});var t=function(a){function m(b,k,e){b=a.call(this,b,e)||this;b._shadowFrustumSize=0;b._shadowOrthoScale=.1;b.autoUpdateExtends=!0;b.autoCalcShadowZBounds=!1;b._orthoLeft=Number.MAX_VALUE;b._orthoRight=Number.MIN_VALUE;b._orthoTop=Number.MIN_VALUE;b._orthoBottom=
Number.MAX_VALUE;b.position=k.scale(-1);b.direction=k;return b}Object(n.d)(m,a);Object.defineProperty(m.prototype,"shadowFrustumSize",{get:function(){return this._shadowFrustumSize},set:function(a){this._shadowFrustumSize=a;this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0});Object.defineProperty(m.prototype,"shadowOrthoScale",{get:function(){return this._shadowOrthoScale},set:function(a){this._shadowOrthoScale=a;this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0});
m.prototype.getClassName=function(){return"DirectionalLight"};m.prototype.getTypeID=function(){return h.a.LIGHTTYPEID_DIRECTIONALLIGHT};m.prototype._setDefaultShadowProjectionMatrix=function(a,k,e){0<this.shadowFrustumSize?this._setDefaultFixedFrustumShadowProjectionMatrix(a):this._setDefaultAutoExtendShadowProjectionMatrix(a,k,e)};m.prototype._setDefaultFixedFrustumShadowProjectionMatrix=function(a){var b=this.getScene().activeCamera;b&&q.a.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,
void 0!==this.shadowMinZ?this.shadowMinZ:b.minZ,void 0!==this.shadowMaxZ?this.shadowMaxZ:b.maxZ,a)};m.prototype._setDefaultAutoExtendShadowProjectionMatrix=function(a,k,e){var b=this.getScene().activeCamera;if(b){if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){var h=q.e.Zero();this._orthoLeft=Number.MAX_VALUE;this._orthoTop=this._orthoRight=Number.MIN_VALUE;for(var u=this._orthoBottom=Number.MAX_VALUE,m=Number.MIN_VALUE,n=0;n<e.length;n++){var A=e[n];if(A){A=A.getBoundingInfo().boundingBox;
for(var l=0;l<A.vectorsWorld.length;l++)q.e.TransformCoordinatesToRef(A.vectorsWorld[l],k,h),h.x<this._orthoLeft&&(this._orthoLeft=h.x),h.y<this._orthoBottom&&(this._orthoBottom=h.y),h.x>this._orthoRight&&(this._orthoRight=h.x),h.y>this._orthoTop&&(this._orthoTop=h.y),this.autoCalcShadowZBounds&&(h.z<u&&(u=h.z),h.z>m&&(m=h.z))}}this.autoCalcShadowZBounds&&(this._shadowMinZ=u,this._shadowMaxZ=m)}k=this._orthoRight-this._orthoLeft;e=this._orthoTop-this._orthoBottom;q.a.OrthoOffCenterLHToRef(this._orthoLeft-
k*this.shadowOrthoScale,this._orthoRight+k*this.shadowOrthoScale,this._orthoBottom-e*this.shadowOrthoScale,this._orthoTop+e*this.shadowOrthoScale,void 0!==this.shadowMinZ?this.shadowMinZ:b.minZ,void 0!==this.shadowMaxZ?this.shadowMaxZ:b.maxZ,a)}};m.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4);this._uniformBuffer.addUniform("vLightDiffuse",4);this._uniformBuffer.addUniform("vLightSpecular",4);this._uniformBuffer.addUniform("shadowsInfo",3);this._uniformBuffer.addUniform("depthValues",
2);this._uniformBuffer.create()};m.prototype.transferToEffect=function(a,k){if(this.computeTransformedInformation())return this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,k),this;this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,k);return this};m.prototype.transferToNodeMaterialEffect=function(a,k){if(this.computeTransformedInformation())return a.setFloat3(k,this.transformedDirection.x,
this.transformedDirection.y,this.transformedDirection.z),this;a.setFloat3(k,this.direction.x,this.direction.y,this.direction.z);return this};m.prototype.getDepthMinZ=function(a){return 1};m.prototype.getDepthMaxZ=function(a){return 1};m.prototype.prepareLightSpecificDefines=function(a,k){a["DIRLIGHT"+k]=!0};Object(n.c)([Object(e.c)()],m.prototype,"shadowFrustumSize",null);Object(n.c)([Object(e.c)()],m.prototype,"shadowOrthoScale",null);Object(n.c)([Object(e.c)()],m.prototype,"autoUpdateExtends",void 0);
Object(n.c)([Object(e.c)()],m.prototype,"autoCalcShadowZBounds",void 0);return m}(a.a)},llUH:function(r,v,a){a.d(v,"a",function(){return b});var n=a("oYeq"),e=a("ADVu"),q=a("/SR9"),h=a("Xeau"),t=a("Ufda"),w=a("Qmvu"),m=a("WHS4"),b=function(a){function b(g,k){g=a.call(this,g,k)||this;g.diffuse=new h.a(1,1,1);g.specular=new h.a(1,1,1);g.falloffType=b.FALLOFF_DEFAULT;g.intensity=1;g._range=Number.MAX_VALUE;g._inverseSquaredRange=0;g._photometricScale=1;g._intensityMode=b.INTENSITYMODE_AUTOMATIC;g._radius=
1E-5;g.renderPriority=0;g._shadowEnabled=!0;g._excludeWithLayerMask=0;g._includeOnlyWithLayerMask=0;g._lightmapMode=0;g._excludedMeshesIds=[];g._includedOnlyMeshesIds=[];g._isLight=!0;g.getScene().addLight(g);g._uniformBuffer=new w.a(g.getScene().getEngine());g._buildUniformLayout();g.includedOnlyMeshes=[];g.excludedMeshes=[];g._resyncMeshes();return g}Object(n.d)(b,a);Object.defineProperty(b.prototype,"range",{get:function(){return this._range},set:function(a){this._range=a;this._inverseSquaredRange=
1/(this.range*this.range)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"intensityMode",{get:function(){return this._intensityMode},set:function(a){this._intensityMode=a;this._computePhotometricScale()},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"radius",{get:function(){return this._radius},set:function(a){this._radius=a;this._computePhotometricScale()},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"shadowEnabled",{get:function(){return this._shadowEnabled},
set:function(a){this._shadowEnabled!==a&&(this._shadowEnabled=a,this._markMeshesAsLightDirty())},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"includedOnlyMeshes",{get:function(){return this._includedOnlyMeshes},set:function(a){this._includedOnlyMeshes=a;this._hookArrayForIncludedOnly(a)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"excludedMeshes",{get:function(){return this._excludedMeshes},set:function(a){this._excludedMeshes=a;this._hookArrayForExcluded(a)},
enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"excludeWithLayerMask",{get:function(){return this._excludeWithLayerMask},set:function(a){this._excludeWithLayerMask=a;this._resyncMeshes()},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"includeOnlyWithLayerMask",{get:function(){return this._includeOnlyWithLayerMask},set:function(a){this._includeOnlyWithLayerMask=a;this._resyncMeshes()},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"lightmapMode",
{get:function(){return this._lightmapMode},set:function(a){this._lightmapMode!==a&&(this._lightmapMode=a,this._markMeshesAsLightDirty())},enumerable:!1,configurable:!0});b.prototype.transferTexturesToEffect=function(a,b){return this};b.prototype._bindLight=function(a,b,k,e,m){void 0===m&&(m=!1);a=a.toString();var g=!1;m&&this._uniformBuffer._alreadyBound||(this._uniformBuffer.bindToEffect(k,"Light"+a),this._renderId===b.getRenderId()&&this._uniformBuffer.useUbo||(this._renderId=b.getRenderId(),m=
this.getScaledIntensity(),this.transferToEffect(k,a),this.diffuse.scaleToRef(m,h.c.Color3[0]),this._uniformBuffer.updateColor4("vLightDiffuse",h.c.Color3[0],this.range,a),e&&(this.specular.scaleToRef(m,h.c.Color3[1]),this._uniformBuffer.updateColor4("vLightSpecular",h.c.Color3[1],this.radius,a)),g=!0),this.transferTexturesToEffect(k,a),b.shadowsEnabled&&this.shadowEnabled&&(b=this.getShadowGenerator())&&(b.bindShadowLight(a,k),g=!0),g&&this._uniformBuffer.update())};b.prototype.getClassName=function(){return"Light"};
b.prototype.toString=function(a){var b="Name: "+this.name;b+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()];if(this.animations)for(var g=0;g<this.animations.length;g++)b+=", animation[0]: "+this.animations[g].toString(a);return b};b.prototype._syncParentEnabledState=function(){a.prototype._syncParentEnabledState.call(this);this.isDisposed()||this._resyncMeshes()};b.prototype.setEnabled=function(b){a.prototype.setEnabled.call(this,b);this._resyncMeshes()};b.prototype.getShadowGenerator=
function(){return this._shadowGenerator};b.prototype.getAbsolutePosition=function(){return q.e.Zero()};b.prototype.canAffectMesh=function(a){return a?this.includedOnlyMeshes&&0<this.includedOnlyMeshes.length&&-1===this.includedOnlyMeshes.indexOf(a)||this.excludedMeshes&&0<this.excludedMeshes.length&&-1!==this.excludedMeshes.indexOf(a)||0!==this.includeOnlyWithLayerMask&&0===(this.includeOnlyWithLayerMask&a.layerMask)||0!==this.excludeWithLayerMask&&this.excludeWithLayerMask&a.layerMask?!1:!0:!0};
b.CompareLightsPriority=function(a,b){return a.shadowEnabled!==b.shadowEnabled?(b.shadowEnabled?1:0)-(a.shadowEnabled?1:0):b.renderPriority-a.renderPriority};b.prototype.dispose=function(b,k){void 0===k&&(k=!1);this._shadowGenerator&&(this._shadowGenerator.dispose(),this._shadowGenerator=null);this.getScene().stopAnimation(this);for(var g=0,e=this.getScene().meshes;g<e.length;g++)e[g]._removeLightSource(this,!0);this._uniformBuffer.dispose();this.getScene().removeLight(this);a.prototype.dispose.call(this,
b,k)};b.prototype.getTypeID=function(){return 0};b.prototype.getScaledIntensity=function(){return this._photometricScale*this.intensity};b.prototype.clone=function(a,k){void 0===k&&(k=null);a=b.GetConstructorFromName(this.getTypeID(),a,this.getScene());if(!a)return null;a=e.a.Clone(a,this);k&&(a.parent=k);a.setEnabled(this.isEnabled());return a};b.prototype.serialize=function(){var a=e.a.Serialize(this);a.type=this.getTypeID();this.parent&&(a.parentId=this.parent.id);0<this.excludedMeshes.length&&
(a.excludedMeshesIds=[],this.excludedMeshes.forEach(function(b){a.excludedMeshesIds.push(b.id)}));0<this.includedOnlyMeshes.length&&(a.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach(function(b){a.includedOnlyMeshesIds.push(b.id)}));e.a.AppendSerializedAnimations(this,a);a.ranges=this.serializeAnimationRanges();return a};b.GetConstructorFromName=function(a,b,k){return(a=t.a.Construct("Light_Type_"+a,b,k))?a:null};b.Parse=function(a,k){var g=b.GetConstructorFromName(a.type,a.name,k);if(!g)return null;
g=e.a.Parse(g,a,k);a.excludedMeshesIds&&(g._excludedMeshesIds=a.excludedMeshesIds);a.includedOnlyMeshesIds&&(g._includedOnlyMeshesIds=a.includedOnlyMeshesIds);a.parentId&&(g._waitingParentId=a.parentId);void 0!==a.falloffType&&(g.falloffType=a.falloffType);void 0!==a.lightmapMode&&(g.lightmapMode=a.lightmapMode);if(a.animations){for(var h=0;h<a.animations.length;h++){var n=a.animations[h],u=m.a.GetClass("BABYLON.Animation");u&&g.animations.push(u.Parse(n))}t.a.ParseAnimationRanges(g,a,k)}a.autoAnimate&&
k.beginAnimation(g,a.autoAnimateFrom,a.autoAnimateTo,a.autoAnimateLoop,a.autoAnimateSpeed||1);return g};b.prototype._hookArrayForExcluded=function(a){var b=this,g=a.push;a.push=function(){for(var k=[],e=0;e<arguments.length;e++)k[e]=arguments[e];e=g.apply(a,k);for(var h=0;h<k.length;h++)k[h]._resyncLightSource(b);return e};var k=a.splice;a.splice=function(g,e){g=k.apply(a,[g,e]);for(e=0;e<g.length;e++)g[e]._resyncLightSource(b);return g};for(var e=0;e<a.length;e++)a[e]._resyncLightSource(this)};b.prototype._hookArrayForIncludedOnly=
function(a){var b=this,g=a.push;a.push=function(){for(var k=[],e=0;e<arguments.length;e++)k[e]=arguments[e];k=g.apply(a,k);b._resyncMeshes();return k};var k=a.splice;a.splice=function(g,e){g=k.apply(a,[g,e]);b._resyncMeshes();return g};this._resyncMeshes()};b.prototype._resyncMeshes=function(){for(var a=0,b=this.getScene().meshes;a<b.length;a++)b[a]._resyncLightSource(this)};b.prototype._markMeshesAsLightDirty=function(){for(var a=0,b=this.getScene().meshes;a<b.length;a++){var k=b[a];-1!==k.lightSources.indexOf(this)&&
k._markSubMeshesAsLightDirty()}};b.prototype._computePhotometricScale=function(){this._photometricScale=this._getPhotometricScale();this.getScene().resetCachedMaterial()};b.prototype._getPhotometricScale=function(){var a=0,k=this.getTypeID(),e=this.intensityMode;e===b.INTENSITYMODE_AUTOMATIC&&(e=k===b.LIGHTTYPEID_DIRECTIONALLIGHT?b.INTENSITYMODE_ILLUMINANCE:b.INTENSITYMODE_LUMINOUSINTENSITY);switch(k){case b.LIGHTTYPEID_POINTLIGHT:case b.LIGHTTYPEID_SPOTLIGHT:switch(e){case b.INTENSITYMODE_LUMINOUSPOWER:a=
1/(4*Math.PI);break;case b.INTENSITYMODE_LUMINOUSINTENSITY:a=1;break;case b.INTENSITYMODE_LUMINANCE:a=this.radius*this.radius}break;case b.LIGHTTYPEID_DIRECTIONALLIGHT:switch(e){case b.INTENSITYMODE_ILLUMINANCE:a=1;break;case b.INTENSITYMODE_LUMINANCE:a=this.radius,a=Math.max(a,.001),a=2*Math.PI*(1-Math.cos(a))}break;case b.LIGHTTYPEID_HEMISPHERICLIGHT:a=1}return a};b.prototype._reorderLightsInScene=function(){var a=this.getScene();0!=this._renderPriority&&(a.requireLightSorting=!0);this.getScene().sortLightsByPriority()};
b.FALLOFF_DEFAULT=0;b.FALLOFF_PHYSICAL=1;b.FALLOFF_GLTF=2;b.FALLOFF_STANDARD=3;b.LIGHTMAP_DEFAULT=0;b.LIGHTMAP_SPECULAR=1;b.LIGHTMAP_SHADOWSONLY=2;b.INTENSITYMODE_AUTOMATIC=0;b.INTENSITYMODE_LUMINOUSPOWER=1;b.INTENSITYMODE_LUMINOUSINTENSITY=2;b.INTENSITYMODE_ILLUMINANCE=3;b.INTENSITYMODE_LUMINANCE=4;b.LIGHTTYPEID_POINTLIGHT=0;b.LIGHTTYPEID_DIRECTIONALLIGHT=1;b.LIGHTTYPEID_SPOTLIGHT=2;b.LIGHTTYPEID_HEMISPHERICLIGHT=3;Object(n.c)([Object(e.e)()],b.prototype,"diffuse",void 0);Object(n.c)([Object(e.e)()],
b.prototype,"specular",void 0);Object(n.c)([Object(e.c)()],b.prototype,"falloffType",void 0);Object(n.c)([Object(e.c)()],b.prototype,"intensity",void 0);Object(n.c)([Object(e.c)()],b.prototype,"range",null);Object(n.c)([Object(e.c)()],b.prototype,"intensityMode",null);Object(n.c)([Object(e.c)()],b.prototype,"radius",null);Object(n.c)([Object(e.c)()],b.prototype,"_renderPriority",void 0);Object(n.c)([Object(e.b)("_reorderLightsInScene")],b.prototype,"renderPriority",void 0);Object(n.c)([Object(e.c)("shadowEnabled")],
b.prototype,"_shadowEnabled",void 0);Object(n.c)([Object(e.c)("excludeWithLayerMask")],b.prototype,"_excludeWithLayerMask",void 0);Object(n.c)([Object(e.c)("includeOnlyWithLayerMask")],b.prototype,"_includeOnlyWithLayerMask",void 0);Object(n.c)([Object(e.c)("lightmapMode")],b.prototype,"_lightmapMode",void 0);return b}(t.a)},odsq:function(r,v,a){r=a("tgKJ");a("8XHp");a("M8EM");var n=a("oYeq"),e=a("ADVu"),q=a("ps+7"),h=a("/SR9"),t=a("qUIE"),w=a("y4Ty"),m=a("cdI9"),b=a("aCSs"),k=a("srWW");v=a("OJ6t");
var u=a("qjwu"),g=a("AGTA"),y=a("KbzI"),x=a("uyO6"),B=a("WHS4"),C=a("Xeau");a("YzlU");a("ibn2");a("L+nt");y.a.prototype.getHighlightLayerByName=function(a){for(var c=0;c<this.effectLayers.length;c++)if(this.effectLayers[c].name===a&&this.effectLayers[c].getEffectName()===l.EffectName)return this.effectLayers[c];return null};var A=function(a){function c(c,d,k,e,g,l,h,m){void 0===l&&(l=b.a.BILINEAR_SAMPLINGMODE);var f=a.call(this,c,"glowBlurPostProcess",["screenSize","direction","blurWidth"],null,e,
g,l,h,m)||this;f.direction=d;f.kernel=k;f.onApplyObservable.add(function(a){a.setFloat2("screenSize",f.width,f.height);a.setVector2("direction",f.direction);a.setFloat("blurWidth",f.kernel)});return f}Object(n.d)(c,a);return c}(v.a),l=function(a){function c(b,d,k){d=a.call(this,b,d)||this;d.name=b;d.innerGlow=!0;d.outerGlow=!0;d.onBeforeBlurObservable=new q.a;d.onAfterBlurObservable=new q.a;d._instanceGlowingMeshStencilReference=c.GlowingMeshStencilReference++;d._meshes={};d._excludedMeshes={};d.neutralColor=
c.NeutralColor;d._engine.isStencilEnable||x.a.Warn("Rendering the Highlight Layer requires the stencil to be active on the canvas. var engine = new Engine(canvas, antialias, { stencil: true }");d._options=Object(n.a)({mainTextureRatio:.5,blurTextureSizeRatio:.5,blurHorizontalSize:1,blurVerticalSize:1,alphaBlendingMode:2,camera:null,renderingGroupId:-1},k);d._init({alphaBlendingMode:d._options.alphaBlendingMode,camera:d._options.camera,mainTextureFixedSize:d._options.mainTextureFixedSize,mainTextureRatio:d._options.mainTextureRatio,
renderingGroupId:d._options.renderingGroupId});d._shouldRender=!1;return d}Object(n.d)(c,a);Object.defineProperty(c.prototype,"blurHorizontalSize",{get:function(){return this._horizontalBlurPostprocess.kernel},set:function(a){this._horizontalBlurPostprocess.kernel=a},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"blurVerticalSize",{get:function(){return this._verticalBlurPostprocess.kernel},set:function(a){this._verticalBlurPostprocess.kernel=a},enumerable:!1,configurable:!0});
c.prototype.getEffectName=function(){return c.EffectName};c.prototype._createMergeEffect=function(){return this._engine.createEffect("glowMapMerge",[w.b.PositionKind],["offset"],["textureSampler"],this._options.isStroke?"#define STROKE \n":void 0)};c.prototype._createTextureAndPostProcesses=function(){var a=this,c=this._mainTextureDesiredSize.width*this._options.blurTextureSizeRatio,e=this._mainTextureDesiredSize.height*this._options.blurTextureSizeRatio;c=this._engine.needPOTTextures?t.a.GetExponentOfTwo(c,
this._maxSize):c;e=this._engine.needPOTTextures?t.a.GetExponentOfTwo(e,this._maxSize):e;var l=0;l=this._engine.getCaps().textureHalfFloatRender?2:0;this._blurTexture=new k.a("HighlightLayerBlurRTT",{width:c,height:e},this._scene,!1,!0,l);this._blurTexture.wrapU=b.a.CLAMP_ADDRESSMODE;this._blurTexture.wrapV=b.a.CLAMP_ADDRESSMODE;this._blurTexture.anisotropicFilteringLevel=16;this._blurTexture.updateSamplingMode(b.a.TRILINEAR_SAMPLINGMODE);this._blurTexture.renderParticles=!1;this._blurTexture.ignoreCameraViewport=
!0;this._textures=[this._blurTexture];2===this._options.alphaBlendingMode?(this._downSamplePostprocess=new u.a("HighlightLayerPPP",this._options.blurTextureSizeRatio,null,b.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._downSamplePostprocess.onApplyObservable.add(function(c){c.setTexture("textureSampler",a._mainTexture)}),this._horizontalBlurPostprocess=new A("HighlightLayerHBP",new h.d(1,0),this._options.blurHorizontalSize,1,null,b.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._horizontalBlurPostprocess.onApplyObservable.add(function(a){a.setFloat2("screenSize",
c,e)}),this._verticalBlurPostprocess=new A("HighlightLayerVBP",new h.d(0,1),this._options.blurVerticalSize,1,null,b.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._verticalBlurPostprocess.onApplyObservable.add(function(a){a.setFloat2("screenSize",c,e)}),this._postProcesses=[this._downSamplePostprocess,this._horizontalBlurPostprocess,this._verticalBlurPostprocess]):(this._horizontalBlurPostprocess=new g.a("HighlightLayerHBP",new h.d(1,0),this._options.blurHorizontalSize/2,{width:c,height:e},
null,b.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,l),this._horizontalBlurPostprocess.width=c,this._horizontalBlurPostprocess.height=e,this._horizontalBlurPostprocess.onApplyObservable.add(function(c){c.setTexture("textureSampler",a._mainTexture)}),this._verticalBlurPostprocess=new g.a("HighlightLayerVBP",new h.d(0,1),this._options.blurVerticalSize/2,{width:c,height:e},null,b.a.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,l),this._postProcesses=[this._horizontalBlurPostprocess,this._verticalBlurPostprocess]);
this._mainTexture.onAfterUnbindObservable.add(function(){a.onBeforeBlurObservable.notifyObservers(a);var c=a._blurTexture.getInternalTexture();c&&(a._scene.postProcessManager.directRender(a._postProcesses,c,!0),a._engine.unBindFramebuffer(c,!0));a.onAfterBlurObservable.notifyObservers(a)});this._postProcesses.map(function(a){a.autoClear=!1})};c.prototype.needStencil=function(){return!0};c.prototype.isReady=function(c,b){var d=c.getMaterial(),f=c.getRenderingMesh();if(!d||!f||!this._meshes)return!1;
var k=null;(f=this._meshes[f.uniqueId])&&f.glowEmissiveOnly&&d&&(k=d.emissiveTexture);return a.prototype._isReady.call(this,c,b,k)};c.prototype._internalRender=function(a){a.setTexture("textureSampler",this._blurTexture);var c=this._engine;c.cacheStencilState();c.setStencilOperationPass(7681);c.setStencilOperationFail(7680);c.setStencilOperationDepthFail(7680);c.setStencilMask(0);c.setStencilBuffer(!0);c.setStencilFunctionReference(this._instanceGlowingMeshStencilReference);this.outerGlow&&(a.setFloat("offset",
0),c.setStencilFunction(517),c.drawElementsType(m.a.TriangleFillMode,0,6));this.innerGlow&&(a.setFloat("offset",1),c.setStencilFunction(514),c.drawElementsType(m.a.TriangleFillMode,0,6));c.restoreStencilState()};c.prototype.shouldRender=function(){return a.prototype.shouldRender.call(this)?this._meshes?!0:!1:!1};c.prototype._shouldRenderMesh=function(c){return this._excludedMeshes&&this._excludedMeshes[c.uniqueId]||!a.prototype.hasMesh.call(this,c)?!1:!0};c.prototype._canRenderMesh=function(a,c){return!0};
c.prototype._addCustomEffectDefines=function(a){a.push("#define HIGHLIGHT")};c.prototype._setEmissiveTextureAndColor=function(a,c,b){(a=this._meshes[a.uniqueId])?this._emissiveTextureAndColor.color.set(a.color.r,a.color.g,a.color.b,1):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a);a&&a.glowEmissiveOnly&&b?(this._emissiveTextureAndColor.texture=b.emissiveTexture,this._emissiveTextureAndColor.color.set(1,1,1,1)):this._emissiveTextureAndColor.texture=
null};c.prototype.addExcludedMesh=function(a){this._excludedMeshes&&(this._excludedMeshes[a.uniqueId]||(this._excludedMeshes[a.uniqueId]={mesh:a,beforeBind:a.onBeforeBindObservable.add(function(a){a.getEngine().setStencilBuffer(!1)}),afterRender:a.onAfterRenderObservable.add(function(a){a.getEngine().setStencilBuffer(!0)})}))};c.prototype.removeExcludedMesh=function(a){if(this._excludedMeshes){var c=this._excludedMeshes[a.uniqueId];c&&(c.beforeBind&&a.onBeforeBindObservable.remove(c.beforeBind),c.afterRender&&
a.onAfterRenderObservable.remove(c.afterRender));this._excludedMeshes[a.uniqueId]=null}};c.prototype.hasMesh=function(c){return this._meshes&&a.prototype.hasMesh.call(this,c)?void 0!==this._meshes[c.uniqueId]&&null!==this._meshes[c.uniqueId]:!1};c.prototype.addMesh=function(a,c,b){var d=this;void 0===b&&(b=!1);if(this._meshes){var f=this._meshes[a.uniqueId];f?f.color=c:(this._meshes[a.uniqueId]={mesh:a,color:c,observerHighlight:a.onBeforeBindObservable.add(function(a){d.isEnabled&&(d._excludedMeshes&&
d._excludedMeshes[a.uniqueId]?d._defaultStencilReference(a):a.getScene().getEngine().setStencilFunctionReference(d._instanceGlowingMeshStencilReference))}),observerDefault:a.onAfterRenderObservable.add(function(a){d.isEnabled&&d._defaultStencilReference(a)}),glowEmissiveOnly:b},a.onDisposeObservable.add(function(){d._disposeMesh(a)}));this._shouldRender=!0}};c.prototype.removeMesh=function(a){if(this._meshes){var c=this._meshes[a.uniqueId];c&&(c.observerHighlight&&a.onBeforeBindObservable.remove(c.observerHighlight),
c.observerDefault&&a.onAfterRenderObservable.remove(c.observerDefault),delete this._meshes[a.uniqueId]);this._shouldRender=!1;for(var b in this._meshes)if(this._meshes[b]){this._shouldRender=!0;break}}};c.prototype.removeAllMeshes=function(){if(this._meshes)for(var a in this._meshes)if(this._meshes.hasOwnProperty(a)){var c=this._meshes[a];c&&this.removeMesh(c.mesh)}};c.prototype._defaultStencilReference=function(a){a.getScene().getEngine().setStencilFunctionReference(c.NormalMeshStencilReference)};
c.prototype._disposeMesh=function(a){this.removeMesh(a);this.removeExcludedMesh(a)};c.prototype.dispose=function(){if(this._meshes){for(var c in this._meshes){var b=this._meshes[c];b&&b.mesh&&(b.observerHighlight&&b.mesh.onBeforeBindObservable.remove(b.observerHighlight),b.observerDefault&&b.mesh.onAfterRenderObservable.remove(b.observerDefault))}this._meshes=null}if(this._excludedMeshes){for(c in this._excludedMeshes)if(b=this._excludedMeshes[c])b.beforeBind&&b.mesh.onBeforeBindObservable.remove(b.beforeBind),
b.afterRender&&b.mesh.onAfterRenderObservable.remove(b.afterRender);this._excludedMeshes=null}a.prototype.dispose.call(this)};c.prototype.getClassName=function(){return"HighlightLayer"};c.prototype.serialize=function(){var a=e.a.Serialize(this);a.customType="BABYLON.HighlightLayer";a.meshes=[];if(this._meshes)for(var c in this._meshes){var b=this._meshes[c];b&&a.meshes.push({glowEmissiveOnly:b.glowEmissiveOnly,color:b.color.asArray(),meshId:b.mesh.id})}a.excludedMeshes=[];if(this._excludedMeshes)for(var k in this._excludedMeshes)(c=
this._excludedMeshes[k])&&a.excludedMeshes.push(c.mesh.id);return a};c.Parse=function(a,b,k){k=e.a.Parse(function(){return new c(a.name,b,a.options)},a,b,k);var d;for(d=0;d<a.excludedMeshes.length;d++){var f=b.getMeshByID(a.excludedMeshes[d]);f&&k.addExcludedMesh(f)}for(d=0;d<a.meshes.length;d++){var g=a.meshes[d];(f=b.getMeshByID(g.meshId))&&k.addMesh(f,C.a.FromArray(g.color),g.glowEmissiveOnly)}return k};c.EffectName="HighlightLayer";c.NeutralColor=new C.b(0,0,0,0);c.GlowingMeshStencilReference=
2;c.NormalMeshStencilReference=1;Object(n.c)([Object(e.c)()],c.prototype,"innerGlow",void 0);Object(n.c)([Object(e.c)()],c.prototype,"outerGlow",void 0);Object(n.c)([Object(e.c)()],c.prototype,"blurHorizontalSize",null);Object(n.c)([Object(e.c)()],c.prototype,"blurVerticalSize",null);Object(n.c)([Object(e.c)("options")],c.prototype,"_options",void 0);return c}(r.a);B.a.RegisteredTypes["BABYLON.HighlightLayer"]=l;a("psaO");a("K32H")},pVyc:function(r,v,a){a.d(v,"a",function(){return w});var n=a("oYeq"),
e=a("ADVu"),q=a("/SR9");r=a("Ufda");var h=a("llUH");v=a("fqU1");var t=a("aCSs");r.a.AddNodeConstructor("Light_Type_2",function(a,b){return function(){return new w(a,q.e.Zero(),q.e.Zero(),0,0,b)}});var w=function(a){function b(b,e,g,h,m,n){b=a.call(this,b,n)||this;b._innerAngle=0;b._projectionTextureMatrix=q.a.Zero();b._projectionTextureLightNear=1E-6;b._projectionTextureLightFar=1E3;b._projectionTextureUpDirection=q.e.Up();b._projectionTextureViewLightDirty=!0;b._projectionTextureProjectionLightDirty=
!0;b._projectionTextureDirty=!0;b._projectionTextureViewTargetVector=q.e.Zero();b._projectionTextureViewLightMatrix=q.a.Zero();b._projectionTextureProjectionLightMatrix=q.a.Zero();b._projectionTextureScalingMatrix=q.a.FromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1);b.position=e;b.direction=g;b.angle=h;b.exponent=m;return b}Object(n.d)(b,a);Object.defineProperty(b.prototype,"angle",{get:function(){return this._angle},set:function(a){this._angle=a;this._cosHalfAngle=Math.cos(.5*a);this._projectionTextureProjectionLightDirty=
!0;this.forceProjectionMatrixCompute();this._computeAngleValues()},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"innerAngle",{get:function(){return this._innerAngle},set:function(a){this._innerAngle=a;this._computeAngleValues()},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"shadowAngleScale",{get:function(){return this._shadowAngleScale},set:function(a){this._shadowAngleScale=a;this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,
"projectionTextureMatrix",{get:function(){return this._projectionTextureMatrix},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"projectionTextureLightNear",{get:function(){return this._projectionTextureLightNear},set:function(a){this._projectionTextureLightNear=a;this._projectionTextureProjectionLightDirty=!0},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"projectionTextureLightFar",{get:function(){return this._projectionTextureLightFar},set:function(a){this._projectionTextureLightFar=
a;this._projectionTextureProjectionLightDirty=!0},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"projectionTextureUpDirection",{get:function(){return this._projectionTextureUpDirection},set:function(a){this._projectionTextureUpDirection=a;this._projectionTextureProjectionLightDirty=!0},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"projectionTexture",{get:function(){return this._projectionTexture},set:function(a){var e=this;this._projectionTexture!==a&&(this._projectionTexture=
a,this._projectionTextureDirty=!0,this._projectionTexture&&!this._projectionTexture.isReady()&&(b._IsProceduralTexture(this._projectionTexture)?this._projectionTexture.getEffect().executeWhenCompiled(function(){e._markMeshesAsLightDirty()}):b._IsTexture(this._projectionTexture)&&this._projectionTexture.onLoadObservable.addOnce(function(){e._markMeshesAsLightDirty()})))},enumerable:!1,configurable:!0});b._IsProceduralTexture=function(a){return void 0!==a.onGeneratedObservable};b._IsTexture=function(a){return void 0!==
a.onLoadObservable};b.prototype.getClassName=function(){return"SpotLight"};b.prototype.getTypeID=function(){return h.a.LIGHTTYPEID_SPOTLIGHT};b.prototype._setDirection=function(b){a.prototype._setDirection.call(this,b);this._projectionTextureViewLightDirty=!0};b.prototype._setPosition=function(b){a.prototype._setPosition.call(this,b);this._projectionTextureViewLightDirty=!0};b.prototype._setDefaultShadowProjectionMatrix=function(a,b,e){if(b=this.getScene().activeCamera)this._shadowAngleScale=this._shadowAngleScale||
1,q.a.PerspectiveFovLHToRef(this._shadowAngleScale*this._angle,1,this.getDepthMinZ(b),this.getDepthMaxZ(b),a)};b.prototype._computeProjectionTextureViewLightMatrix=function(){this._projectionTextureViewLightDirty=!1;this._projectionTextureDirty=!0;this.position.addToRef(this.direction,this._projectionTextureViewTargetVector);q.a.LookAtLHToRef(this.position,this._projectionTextureViewTargetVector,this._projectionTextureUpDirection,this._projectionTextureViewLightMatrix)};b.prototype._computeProjectionTextureProjectionLightMatrix=
function(){this._projectionTextureProjectionLightDirty=!1;this._projectionTextureDirty=!0;var a=this.projectionTextureLightFar,b=this.projectionTextureLightNear;a/=a-b;var e=1/Math.tan(this._angle/2);q.a.FromValuesToRef(e/1,0,0,0,0,e,0,0,0,0,a,1,0,0,-a*b,0,this._projectionTextureProjectionLightMatrix)};b.prototype._computeProjectionTextureMatrix=function(){this._projectionTextureDirty=!1;this._projectionTextureViewLightMatrix.multiplyToRef(this._projectionTextureProjectionLightMatrix,this._projectionTextureMatrix);
this._projectionTexture instanceof t.a&&q.a.FromValuesToRef(this._projectionTexture.uScale/2,0,0,0,0,this._projectionTexture.vScale/2,0,0,0,0,.5,0,.5,.5,.5,1,this._projectionTextureScalingMatrix);this._projectionTextureMatrix.multiplyToRef(this._projectionTextureScalingMatrix,this._projectionTextureMatrix)};b.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4);this._uniformBuffer.addUniform("vLightDiffuse",4);this._uniformBuffer.addUniform("vLightSpecular",4);this._uniformBuffer.addUniform("vLightDirection",
3);this._uniformBuffer.addUniform("vLightFalloff",4);this._uniformBuffer.addUniform("shadowsInfo",3);this._uniformBuffer.addUniform("depthValues",2);this._uniformBuffer.create()};b.prototype._computeAngleValues=function(){this._lightAngleScale=1/Math.max(.001,Math.cos(.5*this._innerAngle)-this._cosHalfAngle);this._lightAngleOffset=-this._cosHalfAngle*this._lightAngleScale};b.prototype.transferTexturesToEffect=function(a,b){this.projectionTexture&&this.projectionTexture.isReady()&&(this._projectionTextureViewLightDirty&&
this._computeProjectionTextureViewLightMatrix(),this._projectionTextureProjectionLightDirty&&this._computeProjectionTextureProjectionLightMatrix(),this._projectionTextureDirty&&this._computeProjectionTextureMatrix(),a.setMatrix("textureProjectionMatrix"+b,this._projectionTextureMatrix),a.setTexture("projectionLightSampler"+b,this.projectionTexture));return this};b.prototype.transferToEffect=function(a,b){this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,
this.transformedPosition.y,this.transformedPosition.z,this.exponent,b),a=q.e.Normalize(this.transformedDirection)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,this.exponent,b),a=q.e.Normalize(this.direction));this._uniformBuffer.updateFloat4("vLightDirection",a.x,a.y,a.z,this._cosHalfAngle,b);this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,this._lightAngleScale,this._lightAngleOffset,b);return this};b.prototype.transferToNodeMaterialEffect=
function(a,b){var e=this.computeTransformedInformation()?q.e.Normalize(this.transformedDirection):q.e.Normalize(this.direction);this.getScene().useRightHandedSystem?a.setFloat3(b,-e.x,-e.y,-e.z):a.setFloat3(b,e.x,e.y,e.z);return this};b.prototype.dispose=function(){a.prototype.dispose.call(this);this._projectionTexture&&this._projectionTexture.dispose()};b.prototype.prepareLightSpecificDefines=function(a,b){a["SPOTLIGHT"+b]=!0;a["PROJECTEDLIGHTTEXTURE"+b]=this.projectionTexture&&this.projectionTexture.isReady()?
!0:!1};Object(n.c)([Object(e.c)()],b.prototype,"angle",null);Object(n.c)([Object(e.c)()],b.prototype,"innerAngle",null);Object(n.c)([Object(e.c)()],b.prototype,"shadowAngleScale",null);Object(n.c)([Object(e.c)()],b.prototype,"exponent",void 0);Object(n.c)([Object(e.c)()],b.prototype,"projectionTextureLightNear",null);Object(n.c)([Object(e.c)()],b.prototype,"projectionTextureLightFar",null);Object(n.c)([Object(e.c)()],b.prototype,"projectionTextureUpDirection",null);Object(n.c)([Object(e.m)("projectedLightTexture")],
b.prototype,"_projectionTexture",void 0);return b}(v.a)},psaO:function(r,v,a){a.d(v,"a",function(){return u});var n=a("ps+7"),e=a("/SR9"),q=a("Xeau"),h=a("e2Mr"),t=a("y4Ty"),w=a("cdI9"),m=a("aCSs"),b=a("Yap0"),k=a("K32H");a("sPPs");a("Fe3i");var u=function(){function a(a,g,r,u,v){this.name=a;this.scale=new e.d(1,1);this.offset=new e.d(0,0);this.alphaBlendingMode=2;this.layerMask=268435455;this.renderTargetTextures=[];this.renderOnlyInRenderTargetTextures=!1;this._vertexBuffers={};this.onDisposeObservable=
new n.a;this.onBeforeRenderObservable=new n.a;this.onAfterRenderObservable=new n.a;this.texture=g?new m.a(g,r,!0):null;this.isBackground=void 0===u?!0:u;this.color=void 0===v?new q.b(1,1,1,1):v;this._scene=r||h.a.LastCreatedScene;a=this._scene._getComponent(b.a.NAME_LAYER);a||(a=new k.a(this._scene),this._scene._addComponent(a));this._scene.layers.push(this);a=this._scene.getEngine();g=[];g.push(1,1);g.push(-1,1);g.push(-1,-1);g.push(1,-1);a=new t.b(a,g,t.b.PositionKind,!1,!1,2);this._vertexBuffers[t.b.PositionKind]=
a;this._createIndexBuffer()}Object.defineProperty(a.prototype,"onDispose",{set:function(a){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver);this._onDisposeObserver=this.onDisposeObservable.add(a)},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"onBeforeRender",{set:function(a){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver);this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(a)},enumerable:!1,
configurable:!0});Object.defineProperty(a.prototype,"onAfterRender",{set:function(a){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver);this._onAfterRenderObserver=this.onAfterRenderObservable.add(a)},enumerable:!1,configurable:!0});a.prototype._createIndexBuffer=function(){var a=this._scene.getEngine(),b=[];b.push(0);b.push(1);b.push(2);b.push(0);b.push(2);b.push(3);this._indexBuffer=a.createIndexBuffer(b)};a.prototype._rebuild=function(){var a=this._vertexBuffers[t.b.PositionKind];
a&&a._rebuild();this._createIndexBuffer()};a.prototype.render=function(){var a=this._scene.getEngine(),b="";this.alphaTest&&(b="#define ALPHATEST");this.texture&&!this.texture.gammaSpace&&(b+="\r\n#define LINEAR");this._previousDefines!==b&&(this._previousDefines=b,this._effect=a.createEffect("layer",[t.b.PositionKind],["textureMatrix","color","scale","offset"],["textureSampler"],b));(b=this._effect)&&b.isReady()&&this.texture&&this.texture.isReady()&&(a=this._scene.getEngine(),this.onBeforeRenderObservable.notifyObservers(this),
a.enableEffect(b),a.setState(!1),b.setTexture("textureSampler",this.texture),b.setMatrix("textureMatrix",this.texture.getTextureMatrix()),b.setFloat4("color",this.color.r,this.color.g,this.color.b,this.color.a),b.setVector2("offset",this.offset),b.setVector2("scale",this.scale),a.bindBuffers(this._vertexBuffers,this._indexBuffer,b),this.alphaTest?a.drawElementsType(w.a.TriangleFillMode,0,6):(a.setAlphaMode(this.alphaBlendingMode),a.drawElementsType(w.a.TriangleFillMode,0,6),a.setAlphaMode(0)),this.onAfterRenderObservable.notifyObservers(this))};
a.prototype.dispose=function(){var a=this._vertexBuffers[t.b.PositionKind];a&&(a.dispose(),this._vertexBuffers[t.b.PositionKind]=null);this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);this.texture&&(this.texture.dispose(),this.texture=null);this.renderTargetTextures=[];a=this._scene.layers.indexOf(this);this._scene.layers.splice(a,1);this.onDisposeObservable.notifyObservers(this);this.onDisposeObservable.clear();this.onAfterRenderObservable.clear();
this.onBeforeRenderObservable.clear()};return a}()},tgKJ:function(r,v,a){a.d(v,"a",function(){return C});var n=a("oYeq"),e=a("ADVu"),q=a("YKqZ"),h=a("ps+7"),t=a("Xeau"),w=a("qUIE"),m=a("e2Mr"),b=a("y4Ty"),k=a("aCSs"),u=a("srWW"),g=a("cdI9"),y=a("/eyM");a("W+To");a("1Fe0");var x=a("n5HA"),B=a("UpSL"),C=function(){function a(b,e){this._vertexBuffers={};this._maxSize=0;this._mainTextureDesiredSize={width:0,height:0};this._shouldRender=!0;this._postProcesses=[];this._textures=[];this._emissiveTextureAndColor=
{texture:null,color:new t.b};this.neutralColor=new t.b;this.isEnabled=!0;this.disableBoundingBoxesFromEffectLayer=!1;this.onDisposeObservable=new h.a;this.onBeforeRenderMainTextureObservable=new h.a;this.onBeforeComposeObservable=new h.a;this.onBeforeRenderMeshToEffect=new h.a;this.onAfterRenderMeshToEffect=new h.a;this.onAfterComposeObservable=new h.a;this.onSizeChangedObservable=new h.a;this.name=b;this._scene=e||m.a.LastCreatedScene;a._SceneComponentInitialization(this._scene);this._engine=this._scene.getEngine();
this._maxSize=this._engine.getCaps().maxTextureSize;this._scene.effectLayers.push(this);this._generateIndexBuffer();this._generateVertexBuffer()}Object.defineProperty(a.prototype,"camera",{get:function(){return this._effectLayerOptions.camera},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"renderingGroupId",{get:function(){return this._effectLayerOptions.renderingGroupId},set:function(a){this._effectLayerOptions.renderingGroupId=a},enumerable:!1,configurable:!0});a.prototype._init=
function(a){this._effectLayerOptions=Object(n.a)({mainTextureRatio:.5,alphaBlendingMode:2,camera:null,renderingGroupId:-1},a);this._setMainTextureSize();this._createMainTexture();this._createTextureAndPostProcesses();this._mergeEffect=this._createMergeEffect()};a.prototype._generateIndexBuffer=function(){var a=[];a.push(0);a.push(1);a.push(2);a.push(0);a.push(2);a.push(3);this._indexBuffer=this._engine.createIndexBuffer(a)};a.prototype._generateVertexBuffer=function(){var a=[];a.push(1,1);a.push(-1,
1);a.push(-1,-1);a.push(1,-1);a=new b.b(this._engine,a,b.b.PositionKind,!1,!1,2);this._vertexBuffers[b.b.PositionKind]=a};a.prototype._setMainTextureSize=function(){this._effectLayerOptions.mainTextureFixedSize?(this._mainTextureDesiredSize.width=this._effectLayerOptions.mainTextureFixedSize,this._mainTextureDesiredSize.height=this._effectLayerOptions.mainTextureFixedSize):(this._mainTextureDesiredSize.width=this._engine.getRenderWidth()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.height=
this._engine.getRenderHeight()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.width=this._engine.needPOTTextures?w.a.GetExponentOfTwo(this._mainTextureDesiredSize.width,this._maxSize):this._mainTextureDesiredSize.width,this._mainTextureDesiredSize.height=this._engine.needPOTTextures?w.a.GetExponentOfTwo(this._mainTextureDesiredSize.height,this._maxSize):this._mainTextureDesiredSize.height);this._mainTextureDesiredSize.width=Math.floor(this._mainTextureDesiredSize.width);this._mainTextureDesiredSize.height=
Math.floor(this._mainTextureDesiredSize.height)};a.prototype._createMainTexture=function(){var a=this;this._mainTexture=new u.a("HighlightLayerMainRTT",{width:this._mainTextureDesiredSize.width,height:this._mainTextureDesiredSize.height},this._scene,!1,!0,0);this._mainTexture.activeCamera=this._effectLayerOptions.camera;this._mainTexture.wrapU=k.a.CLAMP_ADDRESSMODE;this._mainTexture.wrapV=k.a.CLAMP_ADDRESSMODE;this._mainTexture.anisotropicFilteringLevel=1;this._mainTexture.updateSamplingMode(k.a.BILINEAR_SAMPLINGMODE);
this._mainTexture.renderParticles=!1;this._mainTexture.renderList=null;this._mainTexture.ignoreCameraViewport=!0;this._mainTexture.customRenderFunction=function(b,e,d,g){a.onBeforeRenderMainTextureObservable.notifyObservers(a);var c,f=a._scene.getEngine();if(g.length){f.setColorWrite(!1);for(c=0;c<g.length;c++)a._renderSubMesh(g.data[c]);f.setColorWrite(!0)}for(c=0;c<b.length;c++)a._renderSubMesh(b.data[c]);for(c=0;c<e.length;c++)a._renderSubMesh(e.data[c]);b=f.getAlphaMode();for(c=0;c<d.length;c++)a._renderSubMesh(d.data[c],
!0);f.setAlphaMode(b)};this._mainTexture.onClearObservable.add(function(b){b.clear(a.neutralColor,!0,!0,!0)});var b=this._scene.getBoundingBoxRenderer().enabled;this._mainTexture.onBeforeBindObservable.add(function(){a._scene.getBoundingBoxRenderer().enabled=!a.disableBoundingBoxesFromEffectLayer&&b});this._mainTexture.onAfterUnbindObservable.add(function(){a._scene.getBoundingBoxRenderer().enabled=b})};a.prototype._addCustomEffectDefines=function(a){};a.prototype._isReady=function(a,e,c){var f=a.getMaterial();
if(!f||!f.isReadyForSubMesh(a.getMesh(),a,e))return!1;var d=[],g=[b.b.PositionKind],k=a.getMesh(),h=!1,l=!1;if(f){var m=f.needAlphaTesting(),n=f.getAlphaTestTexture(),p=n&&n.hasAlpha&&(f.useAlphaFromDiffuseTexture||f._useAlphaFromAlbedoTexture);n&&(m||p)&&(d.push("#define DIFFUSE"),k.isVerticesDataPresent(b.b.UV2Kind)&&1===n.coordinatesIndex?(d.push("#define DIFFUSEUV2"),l=!0):k.isVerticesDataPresent(b.b.UVKind)&&(d.push("#define DIFFUSEUV1"),h=!0),m&&(d.push("#define ALPHATEST"),d.push("#define ALPHATESTVALUE 0.4")));
if(f=f.opacityTexture)d.push("#define OPACITY"),k.isVerticesDataPresent(b.b.UV2Kind)&&1===f.coordinatesIndex?(d.push("#define OPACITYUV2"),l=!0):k.isVerticesDataPresent(b.b.UVKind)&&(d.push("#define OPACITYUV1"),h=!0)}c&&(d.push("#define EMISSIVE"),k.isVerticesDataPresent(b.b.UV2Kind)&&1===c.coordinatesIndex?(d.push("#define EMISSIVEUV2"),l=!0):k.isVerticesDataPresent(b.b.UVKind)&&(d.push("#define EMISSIVEUV1"),h=!0));k.isVerticesDataPresent(b.b.ColorKind)&&k.hasVertexAlpha&&(g.push(b.b.ColorKind),
d.push("#define VERTEXALPHA"));h&&(g.push(b.b.UVKind),d.push("#define UV1"));l&&(g.push(b.b.UV2Kind),d.push("#define UV2"));c=new B.a;k.useBones&&k.computeBonesUsingShaders?(g.push(b.b.MatricesIndicesKind),g.push(b.b.MatricesWeightsKind),4<k.numBoneInfluencers&&(g.push(b.b.MatricesIndicesExtraKind),g.push(b.b.MatricesWeightsExtraKind)),d.push("#define NUM_BONE_INFLUENCERS "+k.numBoneInfluencers),(h=k.skeleton)&&h.isUsingTextureForMatrices?d.push("#define BONETEXTURE"):d.push("#define BonesPerMesh "+
(h?h.bones.length+1:0)),0<k.numBoneInfluencers&&c.addCPUSkinningFallback(0,k)):d.push("#define NUM_BONE_INFLUENCERS 0");l=k.morphTargetManager;h=0;l&&0<l.numInfluencers&&(d.push("#define MORPHTARGETS"),h=l.numInfluencers,d.push("#define NUM_MORPH_INFLUENCERS "+h),y.a.PrepareAttributesForMorphTargetsInfluencers(g,k,h));e&&(d.push("#define INSTANCES"),y.a.PushAttributesForInstances(g),a.getRenderingMesh().hasThinInstances&&d.push("#define THIN_INSTANCES"));this._addCustomEffectDefines(d);a=d.join("\n");
this._cachedDefines!==a&&(this._cachedDefines=a,this._effectLayerMapGenerationEffect=this._scene.getEngine().createEffect("glowMapGeneration",g,"world mBones viewProjection glowColor morphTargetInfluences boneTextureWidth diffuseMatrix emissiveMatrix opacityMatrix opacityIntensity".split(" "),["diffuseSampler","emissiveSampler","opacitySampler","boneSampler"],a,c,void 0,void 0,{maxSimultaneousMorphTargets:h}));return this._effectLayerMapGenerationEffect.isReady()};a.prototype.render=function(){var a=
this._mergeEffect;if(a.isReady()){for(var b=0;b<this._postProcesses.length;b++)if(!this._postProcesses[b].isReady())return;b=this._scene.getEngine();this.onBeforeComposeObservable.notifyObservers(this);b.enableEffect(a);b.setState(!1);b.bindBuffers(this._vertexBuffers,this._indexBuffer,a);var c=b.getAlphaMode();b.setAlphaMode(this._effectLayerOptions.alphaBlendingMode);this._internalRender(a);b.setAlphaMode(c);this.onAfterComposeObservable.notifyObservers(this);a=this._mainTexture.getSize();this._setMainTextureSize();
if(a.width!==this._mainTextureDesiredSize.width||a.height!==this._mainTextureDesiredSize.height)this.onSizeChangedObservable.notifyObservers(this),this._disposeTextureAndPostProcesses(),this._createMainTexture(),this._createTextureAndPostProcesses()}};a.prototype.hasMesh=function(a){return-1===this.renderingGroupId||a.renderingGroupId===this.renderingGroupId?!0:!1};a.prototype.shouldRender=function(){return this.isEnabled&&this._shouldRender};a.prototype._shouldRenderMesh=function(a){return!0};a.prototype._canRenderMesh=
function(a,b){return!b.needAlphaBlendingForMesh(a)};a.prototype._shouldRenderEmissiveTextureForMesh=function(){return!0};a.prototype._renderSubMesh=function(a,b){var c=this,e;void 0===b&&(b=!1);if(this.shouldRender()){var d=a.getMaterial(),k=a.getMesh(),h=a.getReplacementMesh(),l=a.getRenderingMesh(),m=a.getEffectiveMesh(),n=this._scene,p=n.getEngine();m._internalAbstractMeshDataInfo._isActiveIntermediate=!1;if(d&&this._canRenderMesh(l,d)){var q=null!==(e=l.overrideMaterialSideOrientation)&&void 0!==
e?e:d.sideOrientation;0>l._getWorldMatrixDeterminant()&&(q=q===g.a.ClockWiseSideOrientation?g.a.CounterClockWiseSideOrientation:g.a.ClockWiseSideOrientation);p.setState(d.backFaceCulling,d.zOffset,void 0,q===g.a.ClockWiseSideOrientation);e=l._getInstancesRenderList(a._id,!!h);if(!e.mustReturn&&this._shouldRenderMesh(l)){q=e.hardwareInstancedRendering[a._id]||l.hasThinInstances;this._setEmissiveTextureAndColor(l,a,d);this.onBeforeRenderMeshToEffect.notifyObservers(k);if(this._useMeshMaterial(l))l.render(a,
q,h||void 0);else if(this._isReady(a,q,this._emissiveTextureAndColor.texture)){p.enableEffect(this._effectLayerMapGenerationEffect);l._bind(a,this._effectLayerMapGenerationEffect,g.a.TriangleFillMode);this._effectLayerMapGenerationEffect.setMatrix("viewProjection",n.getTransformMatrix());this._effectLayerMapGenerationEffect.setMatrix("world",m.getWorldMatrix());this._effectLayerMapGenerationEffect.setFloat4("glowColor",this._emissiveTextureAndColor.color.r,this._emissiveTextureAndColor.color.g,this._emissiveTextureAndColor.color.b,
this._emissiveTextureAndColor.color.a);h=d.needAlphaTesting();var r=(n=d.getAlphaTestTexture())&&n.hasAlpha&&(d.useAlphaFromDiffuseTexture||d._useAlphaFromAlbedoTexture);n&&(h||r)&&(this._effectLayerMapGenerationEffect.setTexture("diffuseSampler",n),(h=n.getTextureMatrix())&&this._effectLayerMapGenerationEffect.setMatrix("diffuseMatrix",h));if(h=d.opacityTexture)this._effectLayerMapGenerationEffect.setTexture("opacitySampler",h),this._effectLayerMapGenerationEffect.setFloat("opacityIntensity",h.level),
(h=h.getTextureMatrix())&&this._effectLayerMapGenerationEffect.setMatrix("opacityMatrix",h);this._emissiveTextureAndColor.texture&&(this._effectLayerMapGenerationEffect.setTexture("emissiveSampler",this._emissiveTextureAndColor.texture),this._effectLayerMapGenerationEffect.setMatrix("emissiveMatrix",this._emissiveTextureAndColor.texture.getTextureMatrix()));if(l.useBones&&l.computeBonesUsingShaders&&l.skeleton)if(h=l.skeleton,h.isUsingTextureForMatrices){n=h.getTransformMatrixTexture(l);if(!n)return;
this._effectLayerMapGenerationEffect.setTexture("boneSampler",n);this._effectLayerMapGenerationEffect.setFloat("boneTextureWidth",4*(h.bones.length+1))}else this._effectLayerMapGenerationEffect.setMatrices("mBones",h.getTransformMatrices(l));y.a.BindMorphTargetParameters(l,this._effectLayerMapGenerationEffect);b&&p.setAlphaMode(d.alphaMode);l._processRendering(m,a,this._effectLayerMapGenerationEffect,d.fillMode,e,q,function(a,b){return c._effectLayerMapGenerationEffect.setMatrix("world",b)})}else this._mainTexture.resetRefreshCounter();
this.onAfterRenderMeshToEffect.notifyObservers(k)}}}};a.prototype._useMeshMaterial=function(a){return!1};a.prototype._rebuild=function(){var a=this._vertexBuffers[b.b.PositionKind];a&&a._rebuild();this._generateIndexBuffer()};a.prototype._disposeTextureAndPostProcesses=function(){this._mainTexture.dispose();for(var a=0;a<this._postProcesses.length;a++)this._postProcesses[a]&&this._postProcesses[a].dispose();this._postProcesses=[];for(a=0;a<this._textures.length;a++)this._textures[a]&&this._textures[a].dispose();
this._textures=[]};a.prototype.dispose=function(){var a=this._vertexBuffers[b.b.PositionKind];a&&(a.dispose(),this._vertexBuffers[b.b.PositionKind]=null);this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);this._disposeTextureAndPostProcesses();a=this._scene.effectLayers.indexOf(this,0);-1<a&&this._scene.effectLayers.splice(a,1);this.onDisposeObservable.notifyObservers(this);this.onDisposeObservable.clear();this.onBeforeRenderMainTextureObservable.clear();
this.onBeforeComposeObservable.clear();this.onBeforeRenderMeshToEffect.clear();this.onAfterRenderMeshToEffect.clear();this.onAfterComposeObservable.clear();this.onSizeChangedObservable.clear()};a.prototype.getClassName=function(){return"EffectLayer"};a.Parse=function(a,b,c){return q.b.Instantiate(a.customType).Parse(a,b,c)};a._SceneComponentInitialization=function(a){throw x.a.WarnImport("EffectLayerSceneComponent");};Object(n.c)([Object(e.c)()],a.prototype,"name",void 0);Object(n.c)([Object(e.f)()],
a.prototype,"neutralColor",void 0);Object(n.c)([Object(e.c)()],a.prototype,"isEnabled",void 0);Object(n.c)([Object(e.d)()],a.prototype,"camera",null);Object(n.c)([Object(e.c)()],a.prototype,"renderingGroupId",null);Object(n.c)([Object(e.c)()],a.prototype,"disableBoundingBoxesFromEffectLayer",void 0);return a}()},zZL8:function(r,v,a){a.d(v,"a",function(){return t});var n=a("oYeq"),e=a("ADVu"),q=a("/SR9");r=a("Ufda");var h=a("llUH");a=a("fqU1");r.a.AddNodeConstructor("Light_Type_0",function(a,e){return function(){return new t(a,
q.e.Zero(),e)}});var t=function(a){function m(b,e,h){b=a.call(this,b,h)||this;b._shadowAngle=Math.PI/2;b.position=e;return b}Object(n.d)(m,a);Object.defineProperty(m.prototype,"shadowAngle",{get:function(){return this._shadowAngle},set:function(a){this._shadowAngle=a;this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0});Object.defineProperty(m.prototype,"direction",{get:function(){return this._direction},set:function(a){var b=this.needCube();this._direction=a;this.needCube()!==b&&this._shadowGenerator&&
this._shadowGenerator.recreateShadowMap()},enumerable:!1,configurable:!0});m.prototype.getClassName=function(){return"PointLight"};m.prototype.getTypeID=function(){return h.a.LIGHTTYPEID_POINTLIGHT};m.prototype.needCube=function(){return!this.direction};m.prototype.getShadowDirection=function(b){if(this.direction)return a.prototype.getShadowDirection.call(this,b);switch(b){case 0:return new q.e(1,0,0);case 1:return new q.e(-1,0,0);case 2:return new q.e(0,-1,0);case 3:return new q.e(0,1,0);case 4:return new q.e(0,
0,1);case 5:return new q.e(0,0,-1)}return q.e.Zero()};m.prototype._setDefaultShadowProjectionMatrix=function(a,e,h){(e=this.getScene().activeCamera)&&q.a.PerspectiveFovLHToRef(this.shadowAngle,1,this.getDepthMinZ(e),this.getDepthMaxZ(e),a)};m.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4);this._uniformBuffer.addUniform("vLightDiffuse",4);this._uniformBuffer.addUniform("vLightSpecular",4);this._uniformBuffer.addUniform("vLightFalloff",4);this._uniformBuffer.addUniform("shadowsInfo",
3);this._uniformBuffer.addUniform("depthValues",2);this._uniformBuffer.create()};m.prototype.transferToEffect=function(a,e){this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,e):this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,e);this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,e);return this};m.prototype.transferToNodeMaterialEffect=
function(a,e){this.computeTransformedInformation()?a.setFloat3(e,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z):a.setFloat3(e,this.position.x,this.position.y,this.position.z);return this};m.prototype.prepareLightSpecificDefines=function(a,e){a["POINTLIGHT"+e]=!0};Object(n.c)([Object(e.c)()],m.prototype,"shadowAngle",null);return m}(a.a)}}]);
